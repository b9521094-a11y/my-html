<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å·¥ç¨‹æ•´åˆå·¥å…·ç®±</title>
    <script src="https://unpkg.com/docx@7.1.0/build/index.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    
    <style>
        /* --- å…¨åŸŸå°èˆªèˆ‡ä½ˆå±€æ¨£å¼ --- */
        body {
            margin: 0;
            font-family: 'Microsoft JhengHei', Arial, sans-serif;
            background-color: #e0e0e0; /* é è¨­ä½¿ç”¨å·¥æ¥­é¢¨åº•è‰² */
            padding-top: 60px; /* ç•™å‡ºå°èˆªæ¬„ç©ºé–“ */
        }
        
        /* é ‚éƒ¨å°èˆªæ¬„ */
        .navbar {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            background-color: #343a40;
            display: flex;
            justify-content: center;
            padding: 0;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            z-index: 1000;
        }

        .nav-btn {
            background: none;
            border: none;
            color: #adb5bd;
            padding: 15px 30px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            border-bottom: 4px solid transparent;
            transition: all 0.3s;
        }

        .nav-btn:hover {
            color: #fff;
            background-color: #495057;
        }

        .nav-btn.active {
            color: #ffc107; /* å·¥æ¥­é»ƒ */
            border-bottom: 4px solid #ffc107;
            background-color: #212529;
        }

        /* é é¢åˆ‡æ›æ§åˆ¶ */
        .app-section {
            display: none; /* é è¨­éš±è— */
            padding: 20px;
            animation: fadeIn 0.5s;
        }
        
        .app-section.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* ========================================= */
        /* === 1. å·¥æ¥­é¢¨ç…§ç‰‡æµ®æ°´å°æ¨£å¼ (åŸ index-1218) === */
        /* ========================================= */
        
        .container-watermark { 
            max-width: 650px; 
            margin: auto; 
            background: #ffffff; 
            padding: 30px; 
            border-radius: 4px; 
            box-shadow: 0 4px 15px rgba(0,0,0,0.3); 
            border: 2px solid #495057; 
        }
        .container-watermark h2 { 
            color: #343a40; 
            border-bottom: 5px solid #ffc107; 
            padding-bottom: 15px; 
            text-align: center; 
            margin-bottom: 25px;
        }
        .container-watermark label { 
            display: block; 
            margin-top: 20px; 
            font-weight: bold; 
            color: #343a40; 
            font-size: 1.05em;
        }
        .container-watermark .optional-hint {
            font-size: 0.8em;
            color: #6c757d;
            font-weight: normal;
            margin-left: 5px;
        }
        .container-watermark input[type="text"], 
        .container-watermark input[type="date"], 
        .container-watermark input[type="file"], 
        .container-watermark select { 
            width: 100%; 
            padding: 12px; 
            margin-top: 8px; 
            border: 2px solid #6c757d; 
            border-radius: 0; 
            box-sizing: border-box; 
            font-size: 16px;
            background-color: #f8f9fa;
        }
        .container-watermark input:focus, .container-watermark select:focus {
            border-color: #007bff;
            box-shadow: 0 0 0 1px rgba(0, 123, 255, 0.5); 
            outline: none;
        }
        .hidden-input { display: none; margin-top: 10px; } 
        #status_message { margin-top: 20px; text-align: center; font-weight: bold; min-height: 20px; color: red; }
        
        .btn-primary-w { 
            background-color: #343a40; 
            color: white; 
            padding: 15px 20px; 
            border: none; 
            border-radius: 4px; 
            cursor: pointer; 
            margin-top: 25px; 
            font-size: 18px; 
            width: 100%; 
            font-weight: bold; 
            transition: background-color 0.2s; 
        }
        .btn-primary-w:hover { background-color: #212529; }
        .btn-secondary-w { 
            background-color: #007bff; 
            color: white; 
            padding: 10px 20px; 
            border: none; 
            border-radius: 4px; 
            cursor: pointer; 
            margin-top: 10px; 
            font-size: 16px; 
            width: 100%; 
            transition: background-color 0.2s; 
        }
        .btn-secondary-w:hover { background-color: #0056b3; }
        .btn-clear-w { background-color: #dc3545; }
        .btn-clear-w:hover { background-color: #c82333; }

        /* ç¹ªåœ–å·¥å…·æ¨£å¼ */
        #drawing_tools {
            background-color: #343a40;
            padding: 15px;
            border-radius: 4px;
            border: 1px solid #6c757d;
        }
        #drawing_tools label {
            color: #f8f9fa;
            border-bottom: 1px solid #6c757d;
            padding-bottom: 5px;
        }
        .tool-btn { 
            background-color: #6c757d; 
            color: white; 
            padding: 8px 12px; 
            border: none; 
            border-radius: 4px; 
            cursor: pointer; 
            margin: 2px; 
            font-size: 14px; 
            transition: background-color 0.2s;
        }
        .tool-btn:hover { background-color: #5a6268; }
        .tool-btn[data-selected="true"] { 
            background-color: #007bff; 
            box-shadow: 0 0 8px rgba(0, 123, 255, 0.6); 
        }
        .undo-btn { background-color: #ffc107 !important; color: #343a40 !important; font-weight: bold; }
        .redo-btn { background-color: #17a2b8 !important; color: white !important; font-weight: bold; }
        
        .color-swatch-container { display: flex; gap: 8px; justify-content: center; margin-top: 15px; }
        .color-swatch {
            width: 35px; height: 35px; border-radius: 50%; cursor: pointer;
            border: 3px solid #6c757d; transition: transform 0.1s;
        }
        .color-swatch[data-selected="true"] {
            border-color: #ffc107; transform: scale(1.15); box-shadow: 0 0 5px #ffc107;
        }

        .checkbox-container { display: flex; align-items: center; font-weight: normal; padding: 0;}
        .checkbox-container input[type="checkbox"] { width: auto; margin: 0 5px 0 0; }
        .date-and-checkbox-group { display: flex; align-items: center; gap: 10px; margin-top: 5px;}
        .task-group { display: flex; gap: 15px; }
        .task-group > div { flex: 1; }

        #result_area { margin-top: 30px; text-align: center; display: none; }
        #drawing_container { 
            position: relative; 
            max-width: 100%; 
            display: inline-block; 
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            border-radius: 4px;
        }
        #result_image { 
            max-width: 100%; 
            border: 2px solid #343a40; 
            border-radius: 4px; 
            display: block; 
        }
        #drawing_canvas { 
            position: absolute; top: 0; left: 0; cursor: crosshair;
            border-radius: 4px; pointer-events: none; width: 100%; height: 100%;
        }
        .download-hint { color: #dc3545; margin-top: 10px; font-size: 14px; }

        /* ========================================= */
        /* === 2. å ±è¡¨ç”Ÿæˆå™¨æ¨£å¼ (åŸ index.html) === */
        /* ========================================= */
        
        .container-report { 
            background: white; 
            padding: 15px; 
            border-radius: 8px; 
            max-width: 800px; 
            margin: auto; 
            box-shadow: 0 4px 12px rgba(0,0,0,0.1); 
        }
        .container-report .form-group { margin-bottom: 12px; }
        .container-report .flex-row { display: flex; gap: 10px; }
        .container-report .flex-row > div { flex: 1; }
        .container-report label { display: block; font-weight: bold; margin-bottom: 4px; font-size: 14px; color: #333; }
        .container-report select, .container-report input { width: 100%; padding: 8px; box-sizing: border-box; border: 1px solid #ccc; border-radius: 4px; font-size: 14px; background-color: #fff; }
        
        .photo-card { border: 1px solid #ddd; padding: 15px; margin-bottom: 10px; border-radius: 6px; background: #fff; }
        .photo-card input[type="text"] { margin-top: 8px; padding: 12px; font-size: 15px; border: 1px solid #aaa; }
        
        .checkbox-group { display: flex; gap: 10px; margin-top: 5px; font-size: 13px; }
        
        .btn-preview { background: #28a745; color: white; width: 100%; padding: 12px; border: none; border-radius: 4px; font-size: 16px; cursor: pointer; margin-top: 10px; font-weight: bold; }
        .btn-download { background: #007bff; color: white; width: 100%; padding: 12px; border: none; border-radius: 4px; font-size: 16px; cursor: pointer; margin-top: 10px; font-weight: bold; }

        #preview-area { margin-top: 20px; background: white; padding: 20px; display: none; border: 1px solid #ccc; }
        .report-title-container { text-align: center; position: relative; margin-bottom: 10px; }
        .report-title { font-size: 24px; font-weight: bold; margin: 0; color: #000; }
        .report-sn { position: absolute; right: 0; bottom: 0; font-size: 12px; font-weight: normal; color: #000; }
        
        .outer-table { width: 100%; border-collapse: collapse; table-layout: fixed; }
        .outer-table td { border: 1px solid black; padding: 6px; font-size: 14px; word-break: break-all; vertical-align: middle; color: #000; }
        .label-cell { width: 80px; text-align: center; background-color: #f9f9f9; }
        .content-cell { text-align: left; }
        
        .photo-row { display: flex; border: 1px solid black; border-top: none; height: 220px; }
        .photo-box { width: 65%; border-right: 1px solid black; display: flex; align-items: center; justify-content: center; overflow: hidden; padding: 5px; }
        .photo-box img { max-width: 100%; max-height: 100%; object-fit: contain; }
        .info-box { width: 35%; display: flex; flex-direction: column; }
        .info-item { flex: 1; border-bottom: 1px solid black; padding: 5px; display: flex; flex-direction: column; align-items: flex-start; justify-content: flex-start; text-align: left; font-size: 13px; color: #000; }
        .info-item:last-child { border-bottom: none; }
        .info-label { font-weight: bold; margin-bottom: 2px; }
    </style>
</head>
<body>

<nav class="navbar">
    <button class="nav-btn active" onclick="switchTab('watermark')">å·¥ç¨‹ç…§ç‰‡æµ®æ°´å°</button>
    <button class="nav-btn" onclick="switchTab('report')">è‡ªä¸»æª¢æŸ¥å ±è¡¨</button>
</nav>

<section id="app-watermark" class="app-section active">
    <div class="container-watermark">
        <h2>ğŸ“¸ å·¥ç¨‹ç…§ç‰‡æµ®æ°´å°ç”¢ç”Ÿå™¨</h2>
        
        <div>
            <label for="photo">æ­¥é©Ÿ 1: æ‹ç…§/ä¸Šå‚³ç…§ç‰‡ <span style="color:red">*</span></label>
            <input type="file" id="photo" accept="image/*">
            
            <hr>

            <label for="project_select">æ­¥é©Ÿ 2: å¡«å¯«è³‡æ–™ - å·¥ç¨‹åç¨± <span class="optional-hint">(é¸å¡«)</span></label>
            <select id="project_select" onchange="toggleCustomInput('project_select', 'custom_project_div'); saveProjectName()">
                <option value="" selected>è«‹é¸æ“‡å·¥ç¨‹</option>
                <option value="è¥¿æ¸¯åœ‹ä¸­113å¹´åº¦å»šæˆ¿æ“´å»ºå·¥ç¨‹">è¥¿æ¸¯åœ‹ä¸­113å¹´åº¦å»šæˆ¿æ“´å»ºå·¥ç¨‹</option>
                <option value="ç¶œåˆè¡Œæ”¿å¤§æ¨“(å«äºæ´²èˆªç©ºæ•…äº‹é¤¨ç©ºé–“)æ–°å»ºå·¥ç¨‹">ç¶œåˆè¡Œæ”¿å¤§æ¨“æ–°å»ºå·¥ç¨‹</option>
                <option value="custom_new">è‡ªè¡Œè¼¸å…¥ (å¯ç·¨è¼¯)</option>
            </select>
            <div id="custom_project_div" class="hidden-input">
                <input type="text" id="custom_project_name" placeholder="è«‹è¼¸å…¥å·¥ç¨‹åç¨±" oninput="saveProjectName()">
            </div>
            
            <label for="date_time">æ‹æ”æ™‚é–“</label>
            <div class="date-and-checkbox-group">
                <input type="date" id="date_time" style="flex-grow: 1;">
                <div class="checkbox-container" style="flex-shrink: 0; margin-top: 0;">
                    <input type="checkbox" id="show_date_time" checked>
                    <label for="show_date_time">é¡¯ç¤ºæ™‚é–“</label>
                </div>
            </div>

            <div class="task-group">
                <div>
                    <label for="task_select">å·¥ç¨‹é …ç›® <span class="optional-hint">(é¸å¡«)</span></label> 
                    <select id="task_select" onchange="toggleCustomInput('task_select', 'custom_task_div')">
                        <option value="" selected>è«‹é¸æ“‡å·¥é …</option>
                        <option value="æ¨¡æ¿çµ„ç«‹">æ¨¡æ¿çµ„ç«‹</option>
                        <option value="é‹¼ç­‹ç¶ç´®">é‹¼ç­‹ç¶ç´®</option>
                        <option value="æ°´é›»é…ç®¡">æ°´é›»é…ç®¡</option>
                        <option value="æ¶ˆé˜²é…ç®¡">æ¶ˆé˜²é…ç®¡</option>
                        <option value="æ”¾æ¨£">æ”¾æ¨£</option>
                        <option value="æ··å‡åœŸæ¾†ç½®">æ··å‡åœŸæ¾†ç½®</option>
                        <option value="custom_new">è‡ªè¡Œè¼¸å…¥ (å¯ç·¨è¼¯)</option>
                    </select>
                    <div id="custom_task_div" class="hidden-input">
                        <input type="text" id="custom_task_name" placeholder="è«‹è¼¸å…¥å·¥é …å…§å®¹">
                    </div>
                </div>
                
                <div>
                    <label for="task_remark">å·¥é …å‚™è¨» <span class="optional-hint">(é¸å¡«)</span></label>
                    <input type="text" id="task_remark" placeholder="å‚™è¨»">
                </div>
            </div>


            <label for="position_select">ä½ç½® <span class="optional-hint">(é¸å¡«)</span></label>
            <select id="position_select">
                <option value="" selected>è«‹é¸æ“‡ä½ç½®</option>
                <option value="æ¨‘">æ¨‘</option>
                <option value="æŸ±">æŸ±</option>
                <option value="ç‰ˆ">ç‰ˆ</option>
                <option value="å¤©èŠ±æ¿">å¤©èŠ±æ¿</option>
                <option value="åœ°åª">åœ°åª</option>
                <option value="ç‰†">ç‰†</option>
                <option value="æ¨“æ¢¯">æ¨“æ¢¯</option>
                <option value="æ°´æ± ">æ°´æ± </option>
            </select>
             
            <label for="floor_select">æ¨“å±¤ <span class="optional-hint">(é¸å¡«)</span></label>
            <select id="floor_select">
                <option value="" selected>è«‹é¸æ“‡æ¨“å±¤</option>
                <option value="B1F">B1F</option>
                <option value="1F">1F</option>
                <option value="2F">2F</option>
                <option value="3F">3F</option>
                <option value="4F">4F</option>
                <option value="5F">5F</option>
                <option value="6F">6F</option>
                <option value="7F">7F</option>
                <option value="8F">8F</option>
            </select>
            
             <div id="status_message"></div>
            
            <button type="button" class="btn-primary-w" onclick="generateWatermark()">æ­¥é©Ÿ 3: ç”Ÿæˆå¸¶æœ‰æµ®æ°´å°çš„ç…§ç‰‡</button>
            <button type="button" class="btn-secondary-w btn-clear-w" onclick="clearForm()">æ¸…é™¤æ‰€æœ‰å…§å®¹</button>
        </div>

        <div id="result_area">
            <h3>âœ… ç”Ÿæˆçµæœèˆ‡ç¹ªåœ–å€</h3>
            <div id="drawing_container">
                <img id="result_image" alt="ç”Ÿæˆçµæœ">
                <canvas id="drawing_canvas"></canvas>
            </div>
            
            <div id="drawing_tools">
                <label style="font-weight: bold; display: block; margin-top: 0; margin-bottom: 15px; color: #ffc107;">æ§åˆ¶é¢æ¿ (ç¹ªåœ–)</label>
                
                <div style="display: flex; justify-content: space-between;">
                    <button type="button" class="tool-btn" data-tool="line" data-selected="true" style="flex: 1; margin: 0 10px;">ç·šæ¢</button>
                    <button type="button" class="tool-btn" data-tool="circle" style="flex: 1; margin: 0 10px;">åœ“å½¢</button>
                    <button type="button" class="tool-btn" data-tool="rect" style="flex: 1; margin: 0 10px;">æ–¹å½¢</button>
                    <button type="button" class="tool-btn" data-tool="arrow" style="flex: 1; margin: 0 10px;">ç®­é ­</button>
                </div>
                
                <label style="display: block; font-weight: bold; margin-top: 15px; color: #f8f9fa;">ç·šæ¢é¡è‰²</label>
                <div class="color-swatch-container">
                    <div class="color-swatch" data-color="#dc3545" style="background-color: #dc3545;" data-selected="true"></div> <div class="color-swatch" data-color="#007bff" style="background-color: #007bff;"></div> <div class="color-swatch" data-color="#28a745" style="background-color: #28a745;"></div> <div class="color-swatch" data-color="#ffc107" style="background-color: #ffc107;"></div> <div class="color-swatch" data-color="#fd7e14" style="background-color: #fd7e14;"></div> <div class="color-swatch" data-color="#6f42c1" style="background-color: #6f42c1;"></div> </div>

                <label for="line_width" style="display: block; font-weight: bold; margin-top: 20px; color: #f8f9fa;">ç·šæ¢ç²—ç´°</label>
                <input type="range" id="line_width" min="3" max="15" value="5" style="width: 100%; margin: 0; background-color: #6c757d; border: none;">
                
                <div style="display: flex; justify-content: space-between; margin-top: 20px;">
                    <button type="button" class="tool-btn undo-btn" onclick="undoDrawing()" style="flex: 1; margin-right: 4px;">å¾©åŸ (Ctrl+Z)</button>
                    <button type="button" class="tool-btn redo-btn" onclick="redoDrawing()" style="flex: 1; margin-left: 4px; margin-right: 4px;">é‡åš (Ctrl+Y)</button>
                    <button type="button" class="tool-btn" onclick="clearDrawing()" style="background-color: #dc3545; flex: 1; margin-left: 4px;">æ¸…é™¤ç¹ªåœ–</button>
                </div>
            </div>

            <p class="download-hint">é•·æŒ‰ä¸Šæ–¹åœ–ç‰‡å¯å„²å­˜ï¼Œæˆ–ä½¿ç”¨ä¸‹è¼‰æŒ‰éˆ•ï¼š</p>
            <button type="button" class="btn-secondary-w" id="download_button" style="display: none;">ä¸‹è¼‰ç…§ç‰‡</button> 
        </div>
    </div>
</section>

<section id="app-report" class="app-section">
    <div class="container-report">
        <h2 style="text-align: center; margin-bottom: 20px; color: #333;">ğŸ“‹ å·¥ç¨‹ç´€éŒ„ç”Ÿæˆå™¨</h2>
        <div class="form-group">
            <label>å·¥ç¨‹åç¨±</label>
            <select id="projName" onchange="toggleEdit('projName')">
                <option value="å°æ–°åœ‹å°è“®æ½­é‡Œæ ¡å€åœ‹å°ç¬¬äºŒæœŸæš¨å¢è¨­åœ‹ä¸­æ–°å»ºå·¥ç¨‹æ¡è³¼æ¡ˆ">å°æ–°åœ‹å°äºŒæœŸå·¥ç¨‹</option>
                <option value="è¥¿æ¸¯åœ‹ä¸­">è¥¿æ¸¯åœ‹ä¸­</option>
                <option value="äºæ´²èˆªç©º">äºæ´²èˆªç©º</option>
                <option value="other">---è‡ªå®šç¾©ç·¨è¼¯---</option>
            </select>
            <input type="text" id="projName_edit" style="display:none; margin-top:5px;" placeholder="è«‹è¼¸å…¥å·¥ç¨‹åç¨±">
        </div>

        <div class="flex-row">
            <div class="form-group">
                <label>æŸ¥é©—é …ç›®</label>
                <select id="inspectItem" onchange="toggleEdit('inspectItem')">
                    <option value="æ¨¡æ¿å·¥ç¨‹">æ¨¡æ¿å·¥ç¨‹</option>
                    <option value="é‹¼ç­‹ç¶ç´®">é‹¼ç­‹ç¶ç´®</option>
                    <option value="other">---è‡ªå®šç¾©ç·¨è¼¯---</option>
                </select>
                <input type="text" id="inspectItem_edit" style="display:none; margin-top:5px;">
            </div>
            <div class="form-group">
                <label>æŸ¥é©—ä½ç½®</label>
                <select id="inspectPos" onchange="toggleEdit('inspectPos')">
                    <option value="Kæ£ŸåŸºç¤">Kæ£ŸåŸºç¤</option>
                    <option value="1F">1F</option>
                    <option value="2F">2F</option>
                    <option value="other">---è‡ªå®šç¾©ç·¨è¼¯---</option>
                </select>
                <input type="text" id="inspectPos_edit" style="display:none; margin-top:5px;">
            </div>
        </div>

        <div class="form-group">
            <label>æŸ¥é©—æ—¥æœŸ</label>
            <input type="date" id="inspectDate">
        </div>

        <div id="upload-sections">
            <div class="photo-card">
                <label>ç…§ç‰‡ 1</label>
                <input type="file" id="img1" accept="image/*">
                <input type="text" id="desc1" placeholder="è¼¸å…¥èªªæ˜æ–‡å­—">
                <div class="checkbox-group"><label><input type="checkbox" id="status1"> æ”¹å–„å‰</label></div>
            </div>
            <div class="photo-card">
                <label>ç…§ç‰‡ 2</label>
                <input type="file" id="img2" accept="image/*">
                <input type="text" id="desc2" placeholder="è¼¸å…¥èªªæ˜æ–‡å­—">
                <div class="checkbox-group">
                    <label><input type="checkbox" id="status2_ing"> æ”¹å–„ä¸­</label>
                    <label><input type="checkbox" id="status2_after"> æ”¹å–„å¾Œ</label>
                </div>
            </div>
            <div class="photo-card">
                <label>ç…§ç‰‡ 3</label>
                <input type="file" id="img3" accept="image/*">
                <input type="text" id="desc3" placeholder="è¼¸å…¥èªªæ˜æ–‡å­—">
                <div class="checkbox-group">
                    <label><input type="checkbox" id="status3_ing"> æ”¹å–„ä¸­</label>
                    <label><input type="checkbox" id="status3_after"> æ”¹å–„å¾Œ</label>
                </div>
            </div>
        </div>

        <button class="btn-preview" onclick="generatePreview()">ç”¢ç”Ÿé è¦½</button>
        
        <div id="preview-area">
            <div class="report-title-container">
                <p class="report-title">è‡ªä¸»æª¢æŸ¥ç…§ç‰‡</p>
                <span class="report-sn">ç·¨è™Ÿ: <input type="text" id="serialNo" style="width:40px; border:none; border-bottom:1px solid #000;"></span>
            </div>
            <table class="outer-table">
                <tr>
                    <td class="label-cell">å·¥ç¨‹åç¨±</td>
                    <td colspan="3" class="content-cell" id="p_proj"></td>
                </tr>
                <tr>
                    <td class="label-cell">æ‰¿åŒ…å» å•†</td>
                    <td class="content-cell">å‹å† ç‡Ÿé€ è‚¡ä»½æœ‰é™å…¬å¸</td>
                    <td class="label-cell" style="width:80px;">æŸ¥é©—æ—¥æœŸ</td>
                    <td class="content-cell" id="p_date"></td>
                </tr>
                <tr>
                    <td class="label-cell">æŸ¥é©—é …ç›®</td>
                    <td colspan="3" class="content-cell" id="p_item"></td>
                </tr>
            </table>
            <div id="p_photos"></div>
        </div>

        <button class="btn-download" onclick="downloadWord()">ä¸‹è¼‰ Word æª”</button>
    </div>
</section>

<script>
    // --- åˆ†é åˆ‡æ›åŠŸèƒ½ ---
    function switchTab(tabId) {
        // æ›´æ–°æŒ‰éˆ•ç‹€æ…‹
        document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('active'));
        if(tabId === 'watermark') document.querySelector('.nav-btn:nth-child(1)').classList.add('active');
        if(tabId === 'report') document.querySelector('.nav-btn:nth-child(2)').classList.add('active');

        // æ›´æ–°å€åŸŸé¡¯ç¤º
        document.querySelectorAll('.app-section').forEach(sec => sec.classList.remove('active'));
        document.getElementById('app-' + tabId).classList.add('active');

        // æ›´æ–° Body èƒŒæ™¯è‰²ä»¥ç¬¦åˆè©²é é¢é¢¨æ ¼
        if(tabId === 'watermark') {
            document.body.style.backgroundColor = "#e0e0e0";
        } else {
            document.body.style.backgroundColor = "#f0f2f5";
        }
    }

    // --- å…¨åŸŸåˆå§‹åŒ– ---
    window.onload = function() {
        // åˆå§‹åŒ–æµ®æ°´å°é é¢çš„æ—¥æœŸ
        const now = new Date();
        const year = now.getFullYear();
        const month = String(now.getMonth() + 1).padStart(2, '0');
        const day = String(now.getDate()).padStart(2, '0');
        document.getElementById('date_time').value = `${year}-${month}-${day}`;
        document.getElementById('status_message').style.display = 'none';
        
        // åˆå§‹åŒ–å ±è¡¨é é¢çš„æ—¥æœŸ
        document.getElementById('inspectDate').valueAsDate = new Date();

        // ç¶å®šæµ®æ°´å°ä¸‹è¼‰æŒ‰éˆ•
        document.getElementById('download_button').addEventListener('click', downloadImage);
        document.getElementById('result_area').style.display = 'none';
        
        // è¼‰å…¥æµ®æ°´å°å°ˆæ¡ˆåç¨±èˆ‡ç¹ªåœ–è¨­å®š
        loadProjectName(); 
        setupDrawing(); 
        
        // æµ®æ°´å°é é¢å¿«æ·éµç›£è½ (Ctrl+Z: å¾©åŸ, Ctrl+Y: é‡åš)
        document.addEventListener('keydown', (e) => {
            if (document.getElementById('app-watermark').classList.contains('active')) {
                if (e.ctrlKey || e.metaKey) {
                    if (e.key === 'z') {
                        e.preventDefault();
                        undoDrawing();
                    } else if (e.key === 'y') {
                        e.preventDefault();
                        redoDrawing();
                    }
                }
            }
        });
    };

    /* ======================================================
       === é‚è¼¯å€å¡Š A: æµ®æ°´å°ç”¢ç”Ÿå™¨ (ä¾†è‡ª index-1218.html) === 
       ====================================================== */
    
    const LAST_PROJECT_KEY = 'last_project_name';
    let drawingCanvas, drawingCtx;
    let isDrawing = false;
    let startX = 0, startY = 0;
    let currentTool = 'line'; 
    let lineColor = '#dc3545'; 
    let lineWidth = 5;
    const MAX_HISTORY = 20; 
    let drawingHistory = []; 
    let redoStack = [];      

    function displayStatus(message, isError = false) {
        const statusDiv = document.getElementById('status_message');
        statusDiv.textContent = message;
        statusDiv.style.color = isError ? '#dc3545' : '#1e7e34'; 
        statusDiv.style.display = 'block';
    }

    function toggleCustomInput(selectId, divId) {
        const select = document.getElementById(selectId);
        const div = document.getElementById(divId);
        if (select.value === "custom_new") {
            div.style.display = "block";
        } else {
            div.style.display = "none";
        }
    }
    
    function saveProjectName() {
        const select = document.getElementById('project_select');
        let projectName = '';
        if (select.value === "custom_new") {
            projectName = document.getElementById('custom_project_name').value.trim();
        } else if (select.value !== "") {
            projectName = select.value;
        }
        if (projectName) {
            localStorage.setItem(LAST_PROJECT_KEY, projectName);
            if (select.value !== "custom_new") {
                 document.getElementById('custom_project_name').value = projectName;
            }
        }
    }
    
    function loadProjectName() {
        const lastProject = localStorage.getItem(LAST_PROJECT_KEY);
        const select = document.getElementById('project_select');
        if (lastProject) {
            let found = false;
            for (let i = 0; i < select.options.length; i++) {
                if (select.options[i].value === lastProject) {
                    select.value = lastProject;
                    found = true;
                    break;
                }
            }
            if (!found) {
                select.value = "custom_new";
                document.getElementById('custom_project_name').value = lastProject;
                document.getElementById('custom_project_div').style.display = "block";
            } else {
                document.getElementById('custom_project_div').style.display = "none";
            }
        }
    }

    function getInputValue(selectId, customInputId) {
        const select = document.getElementById(selectId);
        if (select.value === "custom_new") {
            const customInput = document.getElementById(customInputId);
            const value = customInput ? customInput.value.trim() : "";
            if (value === "") return null; 
            return value;
        }
        return select.value === "" ? null : select.value;
    }
    
    function downloadImage() {
        const img = document.getElementById('result_image');
        if (!img.src || img.src.startsWith('data:image/gif')) {
            alert('è«‹å…ˆç”Ÿæˆç…§ç‰‡ï¼');
            return;
        }
        mergeAndDownload();
    }
    
    function dataURLtoBlob(dataurl) {
        var arr = dataurl.split(','), mime = arr[0].match(/:(.*?);/)[1],
            bstr = atob(arr[1]), n = bstr.length, u8arr = new Uint8Array(n);
        while(n--){
            u8arr[n] = bstr.charCodeAt(n);
        }
        return new Blob([u8arr], {type:mime});
    }

    function mergeAndDownload() {
        const project = getInputValue('project_select', 'custom_project_name') || 'å·¥ç¨‹ç…§ç‰‡';
        const date = document.getElementById('date_time').value || 'æœªçŸ¥æ—¥æœŸ';
        const originalImageSrc = document.getElementById('result_image').src; 

        const img = new Image();
        img.crossOrigin = 'Anonymous'; 
        img.src = originalImageSrc;

        img.onload = function() {
            try {
                const finalCanvas = document.createElement('canvas');
                const finalCtx = finalCanvas.getContext('2d');
                finalCanvas.width = img.width;
                finalCanvas.height = img.height;
                finalCtx.drawImage(img, 0, 0); 
                finalCtx.drawImage(drawingCanvas, 0, 0); 
                const dataURL = finalCanvas.toDataURL('image/jpeg', 0.95);
                const blob = dataURLtoBlob(dataURL);
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `${project}_${date}_ç¹ªåœ–.jpg`; 
                document.body.appendChild(a);
                a.click();
                setTimeout(() => {
                    document.body.removeChild(a);
                    window.URL.revokeObjectURL(url);
                }, 100);
                displayStatus("âœ… ç…§ç‰‡å·²æˆåŠŸä¸‹è¼‰ (åŒ…å«ç¹ªåœ–å…§å®¹)ï¼", false);
            } catch (error) {
                console.error("Download Merge Error:", error);
                displayStatus(`ğŸš« ä¸‹è¼‰åˆä½µå¤±æ•—ï¼š${error.message}`, true);
            }
        };
    }
    
    function clearForm() {
        document.getElementById('photo').value = '';
        document.getElementById('project_select').value = '';
        document.getElementById('custom_project_name').value = '';
        document.getElementById('custom_project_div').style.display = 'none';
        
        const now = new Date();
        const year = now.getFullYear();
        const month = String(now.getMonth() + 1).padStart(2, '0');
        const day = String(now.getDate()).padStart(2, '0');
        document.getElementById('date_time').value = `${year}-${month}-${day}`;
        
        document.getElementById('task_select').value = '';
        document.getElementById('custom_task_name').value = '';
        document.getElementById('custom_task_div').style.display = 'none';
        document.getElementById('task_remark').value = '';
        document.getElementById('position_select').value = '';
        document.getElementById('floor_select').value = '';
        document.getElementById('show_date_time').checked = true;

        document.getElementById('status_message').style.display = 'none';
        document.getElementById('result_area').style.display = 'none';
        document.getElementById('result_image').src = '';
        document.getElementById('download_button').style.display = 'none';
        
        if(drawingCanvas) drawingCanvas.style.pointerEvents = 'none';
        clearDrawing();
        localStorage.removeItem(LAST_PROJECT_KEY);
    }

    // --- ç¹ªåœ–åŠŸèƒ½ ---
    function setupDrawing() {
        drawingCanvas = document.getElementById('drawing_canvas');
        drawingCtx = drawingCanvas.getContext('2d');
        
        document.querySelectorAll('.tool-btn[data-tool]').forEach(button => {
            button.addEventListener('click', () => {
                currentTool = button.getAttribute('data-tool');
                document.querySelectorAll('.tool-btn').forEach(btn => btn.removeAttribute('data-selected'));
                button.setAttribute('data-selected', 'true');
                isDrawing = false; 
            });
        });

        document.querySelectorAll('.color-swatch').forEach(swatch => {
            swatch.addEventListener('click', (e) => {
                lineColor = e.target.getAttribute('data-color');
                document.querySelectorAll('.color-swatch').forEach(s => s.removeAttribute('data-selected'));
                e.target.setAttribute('data-selected', 'true');
            });
        });

        document.getElementById('line_width').addEventListener('input', (e) => {
            lineWidth = parseInt(e.target.value, 10);
        });

        drawingCanvas.addEventListener('mousedown', startDrawing);
        drawingCanvas.addEventListener('mousemove', draw);
        drawingCanvas.addEventListener('mouseup', stopDrawing);
        drawingCanvas.addEventListener('mouseout', stopDrawing);
        drawingCanvas.addEventListener('touchstart', startDrawing);
        drawingCanvas.addEventListener('touchmove', draw);
        drawingCanvas.addEventListener('touchend', stopDrawing);
        drawingCanvas.addEventListener('touchcancel', stopDrawing);
    }
    
    function saveState() {
        const dataURL = drawingCanvas.toDataURL();
        if (drawingHistory.length >= MAX_HISTORY) {
            drawingHistory.shift(); 
        }
        drawingHistory.push(dataURL);
        redoStack = [];
    }

    function undoDrawing() {
        if (drawingHistory.length <= 1) {
            clearDrawing(); 
            drawingHistory = [];
            redoStack = []; 
            displayStatus("å·²å¾©åŸåˆ°åˆå§‹ç‹€æ…‹ã€‚", false);
            return;
        }
        const currentState = drawingHistory.pop();
        redoStack.push(currentState);
        const lastState = drawingHistory[drawingHistory.length - 1]; 
        const img = new Image();
        img.onload = function() {
            drawingCtx.clearRect(0, 0, drawingCanvas.width, drawingCanvas.height);
            drawingCtx.drawImage(img, 0, 0);
            displayStatus(`å·²å¾©åŸè‡³ä¸Šä¸€æ­¥ã€‚`, false);
        };
        img.src = lastState;
    }

    function redoDrawing() {
        if (redoStack.length === 0) {
            displayStatus("æ²’æœ‰å¯é‡åšçš„æ­¥é©Ÿã€‚", false);
            return;
        }
        const nextState = redoStack.pop();
        drawingHistory.push(nextState);
        const img = new Image();
        img.onload = function() {
            drawingCtx.clearRect(0, 0, drawingCanvas.width, drawingCanvas.height);
            drawingCtx.drawImage(img, 0, 0);
            displayStatus(`å·²é‡åšè‡³ä¸‹ä¸€æ­¥ã€‚`, false);
        };
        img.src = nextState;
    }

    function getEventCoords(e) {
        if (e.touches && e.touches.length > 0) return e.touches[0];
        if (e.changedTouches && e.changedTouches.length > 0) return e.changedTouches[0];
        return e;
    }

    function getCanvasCoords(e) {
        const rect = drawingCanvas.getBoundingClientRect();
        const displayWidth = rect.width;
        const displayHeight = rect.height;
        const intrinsicWidth = drawingCanvas.width;
        const intrinsicHeight = drawingCanvas.height;
        const scaleX = intrinsicWidth / displayWidth;
        const scaleY = intrinsicHeight / displayHeight;
        return {
            x: (e.clientX - rect.left) * scaleX,
            y: (e.clientY - rect.top) * scaleY
        };
    }

    function drawArrowhead(ctx, x, y, x0, y0, lineW) {
        const angle = Math.atan2(y - y0, x - x0);
        const headLen = lineW * 3; 
        ctx.beginPath();
        ctx.moveTo(x, y);
        ctx.lineTo(x - headLen * Math.cos(angle - Math.PI / 6), y - headLen * Math.sin(angle - Math.PI / 6));
        ctx.moveTo(x, y);
        ctx.lineTo(x - headLen * Math.cos(angle + Math.PI / 6), y - headLen * Math.sin(angle + Math.PI / 6));
        ctx.stroke();
    }

    function startDrawing(e) {
        if (drawingCanvas.style.pointerEvents !== 'auto') return; 
        e.preventDefault(); 
        isDrawing = true;
        const event = getEventCoords(e);
        const coords = getCanvasCoords(event);
        startX = coords.x;
        startY = coords.y;

        drawingCtx.strokeStyle = lineColor;
        drawingCtx.lineWidth = lineWidth;
        drawingCtx.lineCap = 'round';
        drawingCtx.lineJoin = 'round';
        
        if (currentTool === 'line') {
            drawingCtx.beginPath();
            drawingCtx.moveTo(startX, startY);
        }
        if (currentTool !== 'line') {
             saveState(); 
        }
    }

    function draw(e) {
        if (!isDrawing) return;
        e.preventDefault(); 
        const event = getEventCoords(e);
        const coords = getCanvasCoords(event);
        if (currentTool === 'line') {
            drawingCtx.lineTo(coords.x, coords.y);
            drawingCtx.stroke();
        } 
    }

    function stopDrawing(e) {
        if (!isDrawing) return;
        e.preventDefault(); 
        isDrawing = false;
        const event = getEventCoords(e);
        const coords = getCanvasCoords(event);
        const endX = coords.x;
        const endY = coords.y;
        const distance = Math.sqrt(Math.pow(endX - startX, 2) + Math.pow(endY - startY, 2));
        drawingCtx.strokeStyle = lineColor;
        drawingCtx.lineWidth = lineWidth;

        if (currentTool === 'rect' || currentTool === 'circle' || currentTool === 'arrow') {
            if (drawingHistory.length > 0) {
                 const lastState = drawingHistory[drawingHistory.length - 1];
                 const img = new Image();
                 img.onload = function() {
                     drawingCtx.clearRect(0, 0, drawingCanvas.width, drawingCanvas.height);
                     drawingCtx.drawImage(img, 0, 0);
                     drawFinalShape(startX, startY, endX, endY);
                     saveState(); 
                 };
                 img.src = lastState;
            } else {
                 drawFinalShape(startX, startY, endX, endY);
                 saveState();
            }
        } else if (currentTool === 'line') {
            if (distance < 5) {
                 drawingCtx.beginPath();
                 drawingCtx.arc(startX, startY, lineWidth / 2, 0, 2 * Math.PI);
                 drawingCtx.fillStyle = lineColor;
                 drawingCtx.fill();
            }
            saveState(); 
        }
    }

    function drawFinalShape(x0, y0, x1, y1) {
         const w = x1 - x0;
         const h = y1 - y0;
         const distance = Math.sqrt(Math.pow(w, 2) + Math.pow(h, 2));
         if (distance < 5 && currentTool !== 'arrow') return; 

         if (currentTool === 'rect') {
             drawingCtx.strokeRect(x0, y0, w, h);
         } else if (currentTool === 'circle') {
             const radiusX = Math.abs(w / 2);
             const radiusY = Math.abs(h / 2);
             const centerX = x0 + w / 2;
             const centerY = y0 + h / 2;
             drawingCtx.beginPath();
             drawingCtx.ellipse(centerX, centerY, radiusX, radiusY, 0, 0, 2 * Math.PI);
             drawingCtx.stroke();
         } else if (currentTool === 'arrow') {
             drawingCtx.beginPath();
             drawingCtx.moveTo(x0, y0);
             drawingCtx.lineTo(x1, y1);
             drawingCtx.stroke();
             drawArrowhead(drawingCtx, x1, y1, x0, y0, lineWidth);
         }
    }

    function clearDrawing() {
        if(drawingCanvas) {
             drawingCtx.clearRect(0, 0, drawingCanvas.width, drawingCanvas.height);
             drawingHistory = []; 
             redoStack = []; 
        }
    }

    function generateWatermark() {
        displayStatus("æ­£åœ¨è™•ç†ä¸­ï¼Œè«‹ç¨å€™...");
        const photoInput = document.getElementById('photo');
        const project = getInputValue('project_select', 'custom_project_name');
        const date = document.getElementById('date_time').value;
        const floor = document.getElementById('floor_select').value;
        const task = getInputValue('task_select', 'custom_task_name');
        const position = document.getElementById('position_select').value;
        const showTime = document.getElementById('show_date_time').checked;
        const remark = document.getElementById('task_remark').value.trim(); 

        if (!photoInput.files || !photoInput.files[0]) {
            displayStatus("ğŸš« éŒ¯èª¤ï¼šè«‹å‹™å¿…é¸æ“‡ä¸€å¼µç…§ç‰‡ï¼", true);
            return;
        }
        
        const reader = new FileReader();
        reader.onload = function(e) {
            const img = new Image();
            img.src = e.target.result;

            img.onload = function() {
                try {
                    const MAX_SIZE = 4096; 
                    let newWidth = img.width;
                    let newHeight = img.height;

                    if (newWidth > newHeight && newWidth > MAX_SIZE) {
                        newHeight = Math.round(newHeight * MAX_SIZE / newWidth);
                        newWidth = MAX_SIZE;
                    } else if (newHeight > MAX_SIZE) {
                        newWidth = Math.round(newWidth * MAX_SIZE / newHeight);
                        newHeight = MAX_SIZE;
                    }

                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    canvas.width = newWidth;
                    canvas.height = newHeight;
                    ctx.drawImage(img, 0, 0, newWidth, newHeight);
                    
                    drawingCanvas.width = newWidth;
                    drawingCanvas.height = newHeight;
                    ctx.drawImage(drawingCanvas, 0, 0);

                    const baseSize = canvas.width;
                    const fontSize = Math.floor(baseSize * 0.025); 
                    const lineHeight = fontSize * 1.4;
                    const paddingFactor = 0.8; 
                    const padding = fontSize * paddingFactor; 
                    
                    ctx.font = `bold ${fontSize}px "Microsoft JhengHei", Arial`;
                    ctx.textBaseline = 'bottom';
                    ctx.textAlign = 'left'; 
                    
                    let startY = canvas.height - padding;
                    let lines = [];
                    
                    if (project) lines.push(project);
                    if (showTime && date) lines.push(`æ™‚é–“ï¼š ${date}`);
                    if (task) lines.push(`å·¥é …ï¼š ${task}`);
                    if (remark) lines.push(`å‚™è¨»ï¼š ${remark}`);
                    if (position) lines.push(`ä½ç½®ï¼š ${position}`);
                    if (floor) lines.push(`æ¨“å±¤ï¼š ${floor}`);

                    if (lines.length > 0) {
                        let maxWidth = 0;
                        lines.forEach(line => {
                            const currentWidth = ctx.measureText(line).width;
                            if (currentWidth > maxWidth) maxWidth = currentWidth;
                        });
                        
                        const backgroundWidth = maxWidth + 2 * padding; 
                        const totalHeight = lines.length * lineHeight + (lines.length > 0 ? lineHeight * 0.5 : 0);
                        const backgroundY = startY - totalHeight + lineHeight * 0.5;
                        const backgroundX = canvas.width - backgroundWidth; 
                        const startX = backgroundX + padding; 

                        ctx.fillStyle = 'rgba(0, 0, 0, 0.6)'; 
                        ctx.fillRect(backgroundX, backgroundY, backgroundWidth, totalHeight + padding); 

                        lines.forEach((line, index) => {
                            const y = startY - ((lines.length - 1 - index) * lineHeight);
                            ctx.strokeStyle = 'black';
                            ctx.lineWidth = fontSize / 8;
                            ctx.strokeText(line, startX, y); 
                            ctx.fillStyle = '#FFD700'; 
                            ctx.fillText(line, startX, y); 
                        });
                    }

                    const dataURL = canvas.toDataURL('image/jpeg', 0.9);
                    const resultImg = document.getElementById('result_image');
                    resultImg.src = dataURL;
                    
                    document.getElementById('result_area').style.display = 'block';
                    document.getElementById('download_button').style.display = 'block';
                    
                    clearDrawing(); 
                    saveState(); 
                    drawingCanvas.style.pointerEvents = 'auto'; 
                    displayStatus("âœ… æµ®æ°´å°ç…§ç‰‡å·²æˆåŠŸç”Ÿæˆï¼", false);
                    document.getElementById('result_area').scrollIntoView({ behavior: 'smooth' });

                } catch (error) {
                    console.error("Canvas Processing Error:", error);
                    displayStatus(`ğŸš« å…§éƒ¨éŒ¯èª¤ï¼š${error.message}`, true);
                }
            };
        };
        reader.onerror = function(e) { displayStatus("ğŸš« æª”æ¡ˆè®€å–å¤±æ•—ï¼", true); };
        reader.readAsDataURL(photoInput.files[0]);
    }

    /* ======================================================
       === é‚è¼¯å€å¡Š B: å ±è¡¨ç”¢ç”Ÿå™¨ (ä¾†è‡ª index.html) === 
       ====================================================== */

    function toggleEdit(id) {
        const select = document.getElementById(id);
        const editInput = document.getElementById(id + '_edit');
        editInput.style.display = (select.value === 'other') ? 'block' : 'none';
    }

    function getVal(id) {
        const select = document.getElementById(id);
        return select.value === 'other' ? document.getElementById(id + '_edit').value : select.value;
    }

    function toROC(dateStr) {
        if(!dateStr) return "";
        const d = new Date(dateStr);
        return `${d.getFullYear() - 1911}å¹´${d.getMonth() + 1}æœˆ${d.getDate()}æ—¥`;
    }

    async function generatePreview() {
        document.getElementById('p_proj').innerText = getVal('projName');
        document.getElementById('p_date').innerText = toROC(document.getElementById('inspectDate').value);
        document.getElementById('p_item').innerText = getVal('inspectItem');
        
        const photoContainer = document.getElementById('p_photos');
        photoContainer.innerHTML = '';
        document.getElementById('preview-area').style.display = 'block';

        for(let i=1; i<=3; i++) {
            const file = document.getElementById('img'+i).files[0];
            const desc = document.getElementById('desc'+i).value;
            let status = "";
            if(i===1 && document.getElementById('status1').checked) status = "æ”¹å–„å‰";
            if(i>1) {
                if(document.getElementById(`status${i}_ing`).checked) status = "æ”¹å–„ä¸­";
                if(document.getElementById(`status${i}_after`).checked) status = "æ”¹å–„å¾Œ";
            }

            let imgSrc = "";
            if(file) imgSrc = await new Promise(r => {
                const reader = new FileReader();
                reader.onload = e => r(e.target.result);
                reader.readAsDataURL(file);
            });

            const row = document.createElement('div');
            row.className = 'photo-row';
            row.innerHTML = `
                <div class="photo-box">${imgSrc ? `<img src="${imgSrc}">` : ''}</div>
                <div class="info-box">
                    <div class="info-item"><span class="info-label">æŸ¥é©—ä½ç½®ï¼š</span>${getVal('inspectPos')}</div>
                    <div class="info-item"><span class="info-label">èªªæ˜ï¼š</span>${desc} ${status}</div>
                </div>
            `;
            photoContainer.appendChild(row);
        }
    }

    async function downloadWord() {
        const { Document, Packer, Paragraph, Table, TableRow, TableCell, WidthType, ImageRun, AlignmentType, VerticalAlign, TextRun } = docx;

        const createPhotoRow = async (num) => {
            const file = document.getElementById('img'+num).files[0];
            const desc = document.getElementById('desc'+num).value;
            let status = "";
            if(num===1 && document.getElementById('status1').checked) status = "æ”¹å–„å‰";
            if(num>1) {
                if(document.getElementById(`status${num}_ing`).checked) status = "æ”¹å–„ä¸­";
                if(document.getElementById(`status${num}_after`).checked) status = "æ”¹å–„å¾Œ";
            }

            let imgElement = new Paragraph("");
            if(file) {
                const buffer = await file.arrayBuffer();
                imgElement = new Paragraph({
                    children: [new ImageRun({ data: buffer, transformation: { width: 264, height: 198 } })],
                    alignment: AlignmentType.CENTER
                });
            }

            return new TableRow({
                height: { value: 3969, rule: "exact" }, // 7å…¬åˆ†
                children: [
                    new TableCell({ 
                        width: { size: 5670, type: WidthType.DXA }, // 10å…¬åˆ†
                        verticalAlign: VerticalAlign.CENTER, 
                        children: [imgElement] 
                    }),
                    new TableCell({ 
                        width: { size: 4536, type: WidthType.DXA }, 
                        children: [
                            new Paragraph({ 
                                children: [
                                    new TextRun({text: "æŸ¥é©—ä½ç½®ï¼š", bold: true, size: 24, font: "æ¨™æ¥·é«”"}),
                                    new TextRun({text: getVal('inspectPos'), size: 24, font: "æ¨™æ¥·é«”"})
                                ] 
                            }),
                            new Paragraph({ spacing: { before: 200 } }),
                            new Paragraph({ 
                                children: [
                                    new TextRun({text: "èªªæ˜ï¼š", bold: true, size: 24, font: "æ¨™æ¥·é«”"}), 
                                    new TextRun({text: desc + " " + status, size: 24, font: "æ¨™æ¥·é«”"})
                                ] 
                            })
                        ],
                        padding: { top: 100, left: 100 }
                    })
                ]
            });
        };

        const doc = new Document({
            styles: {
                default: {
                    document: {
                        run: {
                            font: "æ¨™æ¥·é«”",
                            size: 24
                        },
                    },
                },
            },
            sections: [{
                properties: {
                    page: {
                        margin: { top: 850.5, bottom: 850.5, left: 850.5, right: 850.5 } // 1.5cm é‚Šç•Œ
                    }
                },
                children: [
                    new Paragraph({
                        alignment: AlignmentType.CENTER,
                        children: [
                            new TextRun({ text: "è‡ªä¸»æª¢æŸ¥ç…§ç‰‡", bold: true, size: 36, font: "æ¨™æ¥·é«”" }),
                            new TextRun({ text: "\t\tç·¨è™Ÿ: " + document.getElementById('serialNo').value, size: 20, font: "æ¨™æ¥·é«”" })
                        ]
                    }),
                    new Table({
                        width: { size: 100, type: WidthType.PERCENTAGE },
                        rows: [
                            new TableRow({ 
                                height: { value: 567, rule: "exact" }, // 1å…¬åˆ†
                                children: [
                                    new TableCell({ 
                                        width: { size: 15, type: WidthType.PERCENTAGE }, 
                                        verticalAlign: VerticalAlign.CENTER,
                                        children: [new Paragraph({ children: [new TextRun({text: "å·¥ç¨‹åç¨±", size: 24, font: "æ¨™æ¥·é«”"})], alignment: AlignmentType.CENTER})] 
                                    }),
                                    new TableCell({ 
                                        width: { size: 85, type: WidthType.PERCENTAGE }, 
                                        columnSpan: 3, 
                                        verticalAlign: VerticalAlign.CENTER,
                                        children: [new Paragraph({ children: [new TextRun({text: getVal('projName'), size: 24, font: "æ¨™æ¥·é«”"})]})] 
                                    })
                                ]
                            }),
                            new TableRow({ 
                                height: { value: 567, rule: "exact" }, // 1å…¬åˆ†
                                children: [
                                    new TableCell({ 
                                        verticalAlign: VerticalAlign.CENTER,
                                        children: [new Paragraph({ children: [new TextRun({text: "æ‰¿åŒ…å» å•†", size: 24, font: "æ¨™æ¥·é«”"})], alignment: AlignmentType.CENTER})] 
                                    }),
                                    new TableCell({ 
                                        verticalAlign: VerticalAlign.CENTER,
                                        children: [new Paragraph({ children: [new TextRun({text: "å‹å† ç‡Ÿé€ è‚¡ä»½æœ‰é™å…¬å¸", size: 24, font: "æ¨™æ¥·é«”"})]})] 
                                    }),
                                    new TableCell({ 
                                        verticalAlign: VerticalAlign.CENTER,
                                        children: [new Paragraph({ children: [new TextRun({text: "æŸ¥é©—æ—¥æœŸ", size: 24, font: "æ¨™æ¥·é«”"})], alignment: AlignmentType.CENTER})] 
                                    }),
                                    new TableCell({ 
                                        verticalAlign: VerticalAlign.CENTER,
                                        children: [new Paragraph({ children: [new TextRun({text: toROC(document.getElementById('inspectDate').value), size: 24, font: "æ¨™æ¥·é«”"})]})] 
                                    })
                                ]
                            }),
                            new TableRow({ 
                                height: { value: 567, rule: "exact" }, // 1å…¬åˆ†
                                children: [
                                    new TableCell({ 
                                        verticalAlign: VerticalAlign.CENTER,
                                        children: [new Paragraph({ children: [new TextRun({text: "æŸ¥é©—é …ç›®", size: 24, font: "æ¨™æ¥·é«”"})], alignment: AlignmentType.CENTER})] 
                                    }),
                                    new TableCell({ 
                                        columnSpan: 3, 
                                        verticalAlign: VerticalAlign.CENTER,
                                        children: [new Paragraph({ children: [new TextRun({text: getVal('inspectItem'), size: 24, font: "æ¨™æ¥·é«”"})]})] 
                                    })
                                ]
                            })
                        ]
                    }),
                    new Paragraph({ spacing: { before: 0, after: 0 }, size: 1 }),
                    new Table({
                        width: { size: 100, type: WidthType.PERCENTAGE },
                        rows: [
                            await createPhotoRow(1),
                            await createPhotoRow(2),
                            await createPhotoRow(3)
                        ]
                    })
                ]
            }]
        });

        Packer.toBlob(doc).then(blob => saveAs(blob, "è‡ªä¸»æª¢æŸ¥æ”¹å–„ç…§ç‰‡.docx"));
    }
</script>

</body>
</html>