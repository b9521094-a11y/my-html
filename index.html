<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å·¥ç¨‹ç…§ç‰‡æµ®æ°´å°ç”¢ç”Ÿå™¨ (å·¥æ¥­é¢¨å°ˆæ¥­ç‰ˆ)</title>
    <style>
        /* --- å·¥æ¥­é¢¨è¨­è¨ˆ --- */
        body { 
            font-family: 'Microsoft JhengHei', Arial, sans-serif; 
            margin: 0; 
            background-color: #e0e0e0; /* æ¨¡æ“¬æ°´æ³¥åœ°æˆ–é‡‘å±¬å…‰æ¾¤çš„è¼•ç°è‰² */
            padding: 25px; 
        }
        .container { 
            max-width: 650px; 
            margin: auto; 
            background: #ffffff; 
            padding: 30px; 
            border-radius: 4px; /* éŠ³åˆ©çš„é‚Šè§’ */
            box-shadow: 0 4px 15px rgba(0,0,0,0.3); /* åšé‡çš„é™°å½± */
            border: 2px solid #495057; /* æ·±è‰²é‚Šæ¡† */
        }
        h2 { 
            color: #343a40; /* æ¿ƒéƒçš„æ·±ç°æ¨™é¡Œ */
            border-bottom: 5px solid #ffc107; /* å®‰å…¨é»ƒ/æ©˜è‰²åº•ç·šä½œç‚ºå·¥æ¥­è­¦ç¤ºè‰² */
            padding-bottom: 15px; 
            text-align: center; 
            margin-bottom: 25px;
        }
        label { 
            display: block; 
            margin-top: 20px; 
            font-weight: bold; 
            color: #343a40; 
            font-size: 1.05em;
        }
        input[type="text"], input[type="date"], input[type="file"], select { 
            width: 100%; 
            padding: 12px; 
            margin-top: 8px; 
            border: 2px solid #6c757d; /* ç°è‰²é‡‘å±¬é‚Šæ¡† */
            border-radius: 0; /* éŠ³è§’ */
            box-sizing: border-box; 
            font-size: 16px;
            background-color: #f8f9fa;
        }
        input[type="text"]:focus, input[type="date"]:focus, select:focus {
            border-color: #007bff;
            box-shadow: 0 0 0 1px rgba(0, 123, 255, 0.5); 
            outline: none;
        }
        select { height: 45px; }
        .hidden-input { display: none; margin-top: 10px; } 
        #status_message { margin-top: 20px; text-align: center; font-weight: bold; min-height: 20px; color: red; } 
        
        /* çµ±ä¸€æŒ‰éˆ•æ¨£å¼ - å·¥æ¥­é¢¨ */
        .btn-primary { 
            background-color: #343a40; /* ç‚­ç°è‰²ä¸»æŒ‰éˆ• */
            color: white; 
            padding: 15px 20px; 
            border: none; 
            border-radius: 4px; 
            cursor: pointer; 
            margin-top: 25px; 
            font-size: 18px; 
            width: 100%; 
            font-weight: bold; 
            transition: background-color 0.2s; 
        }
        .btn-primary:hover { background-color: #212529; }
        .btn-secondary { 
            background-color: #007bff; /* è—è‰²æ¬¡è¦æŒ‰éˆ• */
            color: white; 
            padding: 10px 20px; 
            border: none; 
            border-radius: 4px; 
            cursor: pointer; 
            margin-top: 10px; 
            font-size: 16px; 
            width: 100%; 
            transition: background-color 0.2s; 
        }
        .btn-secondary:hover { background-color: #0056b3; }
        .btn-clear { background-color: #dc3545; } /* ç´…è‰²æ¸…é™¤è­¦å‘Šè‰² */
        .btn-clear:hover { background-color: #c82333; }

        /* ç¹ªåœ–å·¥å…·å€å¡Š - æ§åˆ¶é¢æ¿é¢¨æ ¼ */
        #drawing_tools {
            background-color: #343a40; /* æ·±è‰²èƒŒæ™¯ */
            padding: 15px;
            border-radius: 4px;
            border: 1px solid #6c757d;
        }
        #drawing_tools label {
            color: #f8f9fa; /* æ·ºè‰²æ–‡å­— */
            border-bottom: 1px solid #6c757d;
            padding-bottom: 5px;
        }

        /* ç¹ªåœ–å·¥å…·æŒ‰éˆ•æ¨£å¼ */
        .tool-btn { 
            background-color: #6c757d; 
            color: white; 
            padding: 8px 12px; 
            border: none; 
            border-radius: 4px; 
            cursor: pointer; 
            margin: 2px; 
            font-size: 14px; 
            transition: background-color 0.2s;
        }
        .tool-btn:hover { background-color: #5a6268; }
        .tool-btn[data-selected="true"] { 
            background-color: #007bff; /* é¸ä¸­ç‚ºè—è‰² */
            box-shadow: 0 0 8px rgba(0, 123, 255, 0.6); 
        }
        .undo-btn {
            background-color: #ffc107 !important; /* å®‰å…¨é»ƒè‰² */
            color: #343a40 !important;
            font-weight: bold;
        }
        .undo-btn:hover {
            background-color: #e0a800 !important;
        }
        
        /* é¡è‰²é¸æ“‡å€å¡Š */
        .color-swatch-container {
            display: flex;
            gap: 8px;
            justify-content: center;
            margin-top: 15px;
        }
        .color-swatch {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            cursor: pointer;
            border: 3px solid #6c757d; /* é è¨­é‚Šæ¡† */
            transition: transform 0.1s, border-color 0.2s, box-shadow 0.2s;
        }
        .color-swatch:hover {
            transform: scale(1.1);
        }
        .color-swatch[data-selected="true"] {
            border-color: #ffc107; /* é¸ä¸­æ™‚é‚Šæ¡†è®Šç‚ºå®‰å…¨é»ƒ */
            transform: scale(1.15); 
            box-shadow: 0 0 5px #ffc107;
        }

        /* å…¶ä»–åŸæœ‰æ¨£å¼ä¿æŒä¸è®Š */
        .checkbox-container { display: flex; align-items: center; font-weight: normal; padding: 0;}
        .checkbox-container input[type="checkbox"] { width: auto; margin: 0 5px 0 0; }
        .date-and-checkbox-group { display: flex; align-items: center; gap: 10px; margin-top: 5px;}
        .task-group { display: flex; gap: 15px; }
        .task-group > div { flex: 1; }

        #result_area { margin-top: 30px; text-align: center; display: none; }
        #drawing_container { 
            position: relative; 
            max-width: 100%; 
            display: inline-block; 
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            border-radius: 4px;
        }
        #result_image { 
            max-width: 100%; 
            border: 2px solid #343a40; 
            border-radius: 4px; 
            display: block; 
        }
        #drawing_canvas { 
            position: absolute; 
            top: 0; 
            left: 0; 
            cursor: crosshair;
            border-radius: 4px; 
            pointer-events: none;
            width: 100%; 
            height: 100%;
        }
        .download-hint { color: #dc3545; margin-top: 10px; font-size: 14px; }
    </style>
</head>
<body>

<div class="container">
    <h2>ğŸ“¸ å·¥ç¨‹ç…§ç‰‡æµ®æ°´å°ç”¢ç”Ÿå™¨</h2>
    
    <div>
        <label for="photo">æ­¥é©Ÿ 1: æ‹ç…§/ä¸Šå‚³ç…§ç‰‡</label>
        <input type="file" id="photo" accept="image/*" capture="camera">
        
        <hr>

        <label for="project_select">æ­¥é©Ÿ 2: å¡«å¯«è³‡æ–™ - å·¥ç¨‹åç¨±</label>
        <select id="project_select" onchange="toggleCustomInput('project_select', 'custom_project_div'); saveProjectName()">
            <option value="" disabled selected>è«‹é¸æ“‡å·¥ç¨‹</option>
            <option value="è¥¿æ¸¯åœ‹ä¸­113å¹´åº¦å»šæˆ¿æ“´å»ºå·¥ç¨‹">è¥¿æ¸¯åœ‹ä¸­113å¹´åº¦å»šæˆ¿æ“´å»ºå·¥ç¨‹</option>
            <option value="ç¶œåˆè¡Œæ”¿å¤§æ¨“(å«äºæ´²èˆªç©ºæ•…äº‹é¤¨ç©ºé–“)æ–°å»ºå·¥ç¨‹">ç¶œåˆè¡Œæ”¿å¤§æ¨“æ–°å»ºå·¥ç¨‹</option>
            <option value="custom_new">è‡ªè¡Œè¼¸å…¥ (å¯ç·¨è¼¯)</option>
        </select>
        <div id="custom_project_div" class="hidden-input">
            <input type="text" id="custom_project_name" placeholder="è«‹è¼¸å…¥å·¥ç¨‹åç¨±" oninput="saveProjectName()">
        </div>
        
        <label for="date_time">æ‹æ”æ™‚é–“</label>
        <div class="date-and-checkbox-group">
            <input type="date" id="date_time" style="flex-grow: 1;">
            <div class="checkbox-container" style="flex-shrink: 0; margin-top: 0;">
                <input type="checkbox" id="show_date_time" checked>
                <label for="show_date_time">é¡¯ç¤ºæ™‚é–“</label>
            </div>
        </div>

        <div class="task-group">
            <div>
                <label for="task_select">å·¥é …å…§å®¹</label> 
                <select id="task_select" onchange="toggleCustomInput('task_select', 'custom_task_div')">
                    <option value="" disabled selected>è«‹é¸æ“‡å·¥é …</option>
                    <option value="æ¨¡æ¿çµ„ç«‹">æ¨¡æ¿çµ„ç«‹</option>
                    <option value="é‹¼ç­‹ç¶ç´®">é‹¼ç­‹ç¶ç´®</option>
                    <option value="æ°´é›»é…ç®¡">æ°´é›»é…ç®¡</option>
                    <option value="æ¶ˆé˜²é…ç®¡">æ¶ˆé˜²é…ç®¡</option>
                    <option value="æ”¾æ¨£">æ”¾æ¨£</option>
                    <option value="æ··å‡åœŸæ¾†ç½®">æ··å‡åœŸæ¾†ç½®</option>
                    <option value="custom_new">è‡ªè¡Œè¼¸å…¥ (å¯ç·¨è¼¯)</option>
                </select>
                <div id="custom_task_div" class="hidden-input">
                    <input type="text" id="custom_task_name" placeholder="è«‹è¼¸å…¥å·¥é …å…§å®¹">
                </div>
            </div>
            
            <div>
                <label for="task_remark">å·¥é …å‚™è¨» (é¸å¡«)</label>
                <input type="text" id="task_remark" placeholder="ä¾‹å¦‚ï¼šé…ç­‹æª¢æŸ¥å®Œæˆã€è©¦å£“åˆæ ¼">
            </div>
        </div>


        <label for="position_select">ä½ç½®</label>
        <select id="position_select">
            <option value="" disabled selected>è«‹é¸æ“‡ä½ç½®</option>
            <option value="æ¨‘">æ¨‘</option>
            <option value="æŸ±">æŸ±</option>
            <option value="ç‰ˆ">ç‰ˆ</option>
            <option value="å¤©èŠ±æ¿">å¤©èŠ±æ¿</option>
            <option value="åœ°åª">åœ°åª</option>
            <option value="ç‰†">ç‰†</option>
            <option value="æ¨“æ¢¯">æ¨“æ¢¯</option>
            <option value="æ°´æ± ">æ°´æ± </option>
        </select>
         
        <label for="floor_select">æ¨“å±¤</label>
        <select id="floor_select">
            <option value="" disabled selected>è«‹é¸æ“‡æ¨“å±¤</option>
            <option value="B1F">B1F</option>
            <option value="1F">1F</option>
            <option value="2F">2F</option>
            <option value="3F">3F</option>
            <option value="4F">4F</option>
            <option value="5F">5F</option>
            <option value="6F">6F</option>
            <option value="7F">7F</option>
            <option value="8F">8F</option>
        </select>
        
         <div id="status_message"></div>
        
        <button type="button" class="btn-primary" onclick="generateWatermark()">æ­¥é©Ÿ 3: ç”Ÿæˆå¸¶æœ‰æµ®æ°´å°çš„ç…§ç‰‡</button>
        <button type="button" class="btn-secondary btn-clear" onclick="clearForm()">æ¸…é™¤æ‰€æœ‰å…§å®¹</button>
    </div>

    <div id="result_area">
        <h3>âœ… ç”Ÿæˆçµæœèˆ‡ç¹ªåœ–å€</h3>
        <div id="drawing_container">
            <img id="result_image" alt="ç”Ÿæˆçµæœ">
            <canvas id="drawing_canvas"></canvas>
        </div>
        
        <div id="drawing_tools">
            <label style="font-weight: bold; display: block; margin-top: 0; margin-bottom: 15px; color: #ffc107;">æ§åˆ¶é¢æ¿ (ç¹ªåœ–)</label>
            
            <div style="display: flex; justify-content: space-between;">
                <button type="button" class="tool-btn" data-tool="line" data-selected="true" style="flex: 1; margin: 0 4px;">ç·šæ¢</button>
                <button type="button" class="tool-btn" data-tool="circle" style="flex: 1; margin: 0 4px;">åœ“å½¢</button>
                <button type="button" class="tool-btn" data-tool="rect" style="flex: 1; margin: 0 4px;">æ–¹å½¢</button>
                <button type="button" class="tool-btn" data-tool="arrow" style="flex: 1; margin: 0 4px;">ç®­é ­</button>
            </div>
            
            <label style="display: block; font-weight: bold; margin-top: 15px; color: #f8f9fa;">ç·šæ¢é¡è‰² (6è‰²)</label>
            <div class="color-swatch-container">
                <div class="color-swatch" data-color="#dc3545" style="background-color: #dc3545;" data-selected="true"></div> <div class="color-swatch" data-color="#007bff" style="background-color: #007bff;"></div> <div class="color-swatch" data-color="#28a745" style="background-color: #28a745;"></div> <div class="color-swatch" data-color="#ffc107" style="background-color: #ffc107;"></div> <div class="color-swatch" data-color="#fd7e14" style="background-color: #fd7e14;"></div> <div class="color-swatch" data-color="#6f42c1" style="background-color: #6f42c1;"></div> </div>

            <label for="line_width" style="display: block; font-weight: bold; margin-top: 20px; color: #f8f9fa;">ç·šæ¢ç²—ç´°</label>
            <input type="range" id="line_width" min="3" max="15" value="5" style="width: 100%; margin: 0; background-color: #6c757d; border: none;">
            
            <div style="display: flex; justify-content: space-between; margin-top: 20px;">
                <button type="button" class="tool-btn undo-btn" onclick="undoDrawing()" style="flex: 1; margin-right: 8px;">å¾©åŸ (Ctrl+Z)</button>
                <button type="button" class="tool-btn" onclick="clearDrawing()" style="background-color: #dc3545; flex: 1; margin-left: 8px;">æ¸…é™¤ç¹ªåœ–</button>
            </div>
        </div>

        <p class="download-hint">é•·æŒ‰ä¸Šæ–¹åœ–ç‰‡å¯å„²å­˜ï¼Œæˆ–ä½¿ç”¨ä¸‹è¼‰æŒ‰éˆ•ï¼š</p>
        <button type="button" class="btn-secondary" id="download_button" style="display: none;">ä¸‹è¼‰ç…§ç‰‡</button> 
    </div>
</div>

<script>
    const LAST_PROJECT_KEY = 'last_project_name';

    // å…¨åŸŸç¹ªåœ–ç‹€æ…‹
    let drawingCanvas, drawingCtx;
    let isDrawing = false;
    let startX = 0, startY = 0;
    let currentTool = 'line'; 
    let lineColor = '#dc3545'; 
    let lineWidth = 5;
    
    // ã€å¾©åŸåŠŸèƒ½ã€‘: ç¹ªåœ–æ­·å²å †ç–Š
    const MAX_HISTORY = 20; 
    let drawingHistory = [];

    // 1. åˆå§‹åŒ–è¨­å®š
    window.onload = function() {
        const now = new Date();
        const year = now.getFullYear();
        const month = String(now.getMonth() + 1).padStart(2, '0');
        const day = String(now.getDate()).padStart(2, '0');
        document.getElementById('date_time').value = `${year}-${month}-${day}`;
        document.getElementById('status_message').style.display = 'none';
        
        document.getElementById('download_button').addEventListener('click', downloadImage);
        document.getElementById('result_area').style.display = 'none';
        
        loadProjectName(); 
        setupDrawing(); 
        
        // å¿«æ·éµç›£è½ (Ctrl+Z)
        document.addEventListener('keydown', (e) => {
            if ((e.ctrlKey || e.metaKey) && e.key === 'z') {
                e.preventDefault();
                undoDrawing();
            }
        });
    };
    
    // 2. é¡¯ç¤º/éš±è—ç‹€æ…‹è¨Šæ¯
    function displayStatus(message, isError = false) {
        const statusDiv = document.getElementById('status_message');
        statusDiv.textContent = message;
        statusDiv.style.color = isError ? '#dc3545' : '#1e7e34'; 
        statusDiv.style.display = 'block';
    }

    // 3. åˆ‡æ›è‡ªè¨‚è¼¸å…¥æ¡†é¡¯ç¤º
    function toggleCustomInput(selectId, divId) {
        const select = document.getElementById(selectId);
        const div = document.getElementById(divId);
        const input = div.querySelector('input[type="text"]'); 

        if (select.value === "custom_new") {
            div.style.display = "block";
            if (input) input.setAttribute('required', 'required'); 
        } else {
            div.style.display = "none";
            if (input) input.removeAttribute('required'); 
        }
    }
    
    // 4. å„²å­˜å·¥ç¨‹åç¨± (ç•¥)
    function saveProjectName() {
        const select = document.getElementById('project_select');
        let projectName = '';
        if (select.value === "custom_new") {
            projectName = document.getElementById('custom_project_name').value.trim();
        } else if (select.value !== "") {
            projectName = select.value;
        }
        if (projectName) {
            localStorage.setItem(LAST_PROJECT_KEY, projectName);
            if (select.value !== "custom_new") {
                 document.getElementById('custom_project_name').value = projectName;
            }
        }
    }
    
    // 5. è¼‰å…¥å·¥ç¨‹åç¨± (ç•¥)
    function loadProjectName() {
        const lastProject = localStorage.getItem(LAST_PROJECT_KEY);
        const select = document.getElementById('project_select');
        if (lastProject) {
            let found = false;
            for (let i = 0; i < select.options.length; i++) {
                if (select.options[i].value === lastProject) {
                    select.value = lastProject;
                    found = true;
                    break;
                }
            }
            if (!found) {
                select.value = "custom_new";
                document.getElementById('custom_project_name').value = lastProject;
                document.getElementById('custom_project_div').style.display = "block";
            } else {
                document.getElementById('custom_project_div').style.display = "none";
            }
        }
    }

    // 6. å–å¾—æœ€çµ‚è¼¸å…¥å€¼
    function getInputValue(selectId, customInputId) {
        const select = document.getElementById(selectId);
        if (select.value === "custom_new") {
            const customInput = document.getElementById(customInputId);
            const value = customInput ? customInput.value.trim() : "";
            if (value === "") {
                return null; 
            }
            return value;
        }
        return select.value;
    }
    
    // 7. ä¸‹è¼‰åœ–ç‰‡åŠŸèƒ½ (ç•¥)
    function downloadImage() {
        const img = document.getElementById('result_image');
        if (!img.src || img.src.startsWith('data:image/gif')) {
            alert('è«‹å…ˆç”Ÿæˆç…§ç‰‡ï¼');
            return;
        }
        
        mergeAndDownload();
    }
    
    // 8. åˆä½µç¹ªåœ–å’Œæµ®æ°´å°ï¼Œä¸¦ä¸‹è¼‰ (ç•¥)
    function mergeAndDownload() {
        const project = getInputValue('project_select', 'custom_project_name') || 'å·¥ç¨‹ç…§ç‰‡';
        const date = document.getElementById('date_time').value || 'æœªçŸ¥æ—¥æœŸ';
        const originalImageSrc = document.getElementById('result_image').src; 

        const img = new Image();
        img.crossOrigin = 'Anonymous'; 
        img.src = originalImageSrc;

        img.onload = function() {
            try {
                const finalCanvas = document.createElement('canvas');
                const finalCtx = finalCanvas.getContext('2d');

                finalCanvas.width = img.width;
                finalCanvas.height = img.height;
                finalCtx.drawImage(img, 0, 0); 

                finalCtx.drawImage(drawingCanvas, 0, 0); 

                const dataURL = finalCanvas.toDataURL('image/jpeg', 0.9);
                
                const a = document.createElement('a');
                a.href = dataURL;
                a.download = `${project}_${date}_ç¹ªåœ–.jpg`; 
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                displayStatus("âœ… ç…§ç‰‡å·²æˆåŠŸä¸‹è¼‰ (åŒ…å«ç¹ªåœ–å…§å®¹)ï¼", false);

            } catch (error) {
                console.error("Download Merge Error:", error);
                displayStatus(`ğŸš« ä¸‹è¼‰åˆä½µå¤±æ•—ï¼š${error.message}`, true);
            }
        };
    }
    
    // 9. æ¸…é™¤æ‰€æœ‰å…§å®¹ (ç•¥)
    function clearForm() {
        document.getElementById('photo').value = '';
        document.getElementById('project_select').value = '';
        document.getElementById('custom_project_name').value = '';
        document.getElementById('custom_project_div').style.display = 'none';
        
        const now = new Date();
        const year = now.getFullYear();
        const month = String(now.getMonth() + 1).padStart(2, '0');
        const day = String(now.getDate()).padStart(2, '0');
        document.getElementById('date_time').value = `${year}-${month}-${day}`;
        
        document.getElementById('task_select').value = '';
        document.getElementById('custom_task_name').value = '';
        document.getElementById('custom_task_div').style.display = 'none';
        document.getElementById('task_remark').value = '';
        document.getElementById('position_select').value = '';
        document.getElementById('floor_select').value = '';
        document.getElementById('show_date_time').checked = true;

        document.getElementById('status_message').style.display = 'none';
        document.getElementById('result_area').style.display = 'none';
        document.getElementById('result_image').src = '';
        document.getElementById('download_button').style.display = 'none';
        
        if(drawingCanvas) drawingCanvas.style.pointerEvents = 'none';
        clearDrawing();
        drawingHistory = []; 

        localStorage.removeItem(LAST_PROJECT_KEY);
    }

    // --- ç¹ªåœ–åŠŸèƒ½å¯¦ä½œ (ç•¥) ---
    // (getEventCoords, getCanvasCoords, drawArrowhead, setupDrawing, saveState, undoDrawing, startDrawing, draw, stopDrawing, drawFinalShape, clearDrawing ç­‰å‡½æ•¸ä¿æŒä¸è®Š)
    
    // 10. åˆå§‹åŒ–ç¹ªåœ– (ç•¥)
    function setupDrawing() {
        drawingCanvas = document.getElementById('drawing_canvas');
        drawingCtx = drawingCanvas.getContext('2d');
        
        // å·¥å…·é¸æ“‡ (ç•¥)
        document.querySelectorAll('.tool-btn[data-tool]').forEach(button => {
            button.addEventListener('click', () => {
                currentTool = button.getAttribute('data-tool');
                document.querySelectorAll('.tool-btn').forEach(btn => btn.removeAttribute('data-selected'));
                button.setAttribute('data-selected', 'true');
                isDrawing = false; 
            });
        });

        // é¡è‰²é¸æ“‡ (ç•¥)
        document.querySelectorAll('.color-swatch').forEach(swatch => {
            swatch.addEventListener('click', (e) => {
                lineColor = e.target.getAttribute('data-color');
                document.querySelectorAll('.color-swatch').forEach(s => s.removeAttribute('data-selected'));
                e.target.setAttribute('data-selected', 'true');
            });
        });

        // ç·šæ¢ç²—ç´°é¸æ“‡ (ç•¥)
        document.getElementById('line_width').addEventListener('input', (e) => {
            lineWidth = parseInt(e.target.value, 10);
        });

        // äº‹ä»¶ç›£è½ (æ»‘é¼ /è§¸æ§) (ç•¥)
        drawingCanvas.addEventListener('mousedown', startDrawing);
        drawingCanvas.addEventListener('mousemove', draw);
        drawingCanvas.addEventListener('mouseup', stopDrawing);
        drawingCanvas.addEventListener('mouseout', stopDrawing);
        drawingCanvas.addEventListener('touchstart', startDrawing);
        drawingCanvas.addEventListener('touchmove', draw);
        drawingCanvas.addEventListener('touchend', stopDrawing);
        drawingCanvas.addEventListener('touchcancel', stopDrawing);
    }
    
    // ã€å¾©åŸåŠŸèƒ½ã€‘: å„²å­˜ç•¶å‰ç•«å¸ƒç‹€æ…‹
    function saveState() {
        const dataURL = drawingCanvas.toDataURL();
        if (drawingHistory.length >= MAX_HISTORY) {
            drawingHistory.shift(); 
        }
        drawingHistory.push(dataURL);
    }

    // ã€å¾©åŸåŠŸèƒ½ã€‘: åŸ·è¡Œå¾©åŸ
    function undoDrawing() {
        if (drawingHistory.length <= 1) {
            clearDrawing(); 
            drawingHistory = [];
            displayStatus("å·²å¾©åŸåˆ°åˆå§‹ç‹€æ…‹ã€‚", false);
            return;
        }

        drawingHistory.pop(); 
        const lastState = drawingHistory[drawingHistory.length - 1]; 

        const img = new Image();
        img.onload = function() {
            clearDrawing();
            drawingCtx.drawImage(img, 0, 0);
            displayStatus(`å·²å¾©åŸè‡³ä¸Šä¸€æ­¥ã€‚ (å‰©é¤˜ ${drawingHistory.length - 1} æ­¥å¯å¾©åŸ)`, false);
        };
        img.src = lastState;
    }

    function getEventCoords(e) {
        if (e.touches && e.touches.length > 0) {
            return e.touches[0];
        }
        if (e.changedTouches && e.changedTouches.length > 0) {
            return e.changedTouches[0];
        }
        return e;
    }

    function getCanvasCoords(e) {
        const rect = drawingCanvas.getBoundingClientRect();
        const displayWidth = rect.width;
        const displayHeight = rect.height;
        
        const intrinsicWidth = drawingCanvas.width;
        const intrinsicHeight = drawingCanvas.height;

        const scaleX = intrinsicWidth / displayWidth;
        const scaleY = intrinsicHeight / displayHeight;
        
        return {
            x: (e.clientX - rect.left) * scaleX,
            y: (e.clientY - rect.top) * scaleY
        };
    }

    function drawArrowhead(ctx, x, y, x0, y0, lineW) {
        const angle = Math.atan2(y - y0, x - x0);
        const headLen = lineW * 3; 
        
        ctx.beginPath();
        ctx.moveTo(x, y);
        ctx.lineTo(x - headLen * Math.cos(angle - Math.PI / 6), y - headLen * Math.sin(angle - Math.PI / 6));
        ctx.moveTo(x, y);
        ctx.lineTo(x - headLen * Math.cos(angle + Math.PI / 6), y - headLen * Math.sin(angle + Math.PI / 6));
        ctx.stroke();
    }

    function startDrawing(e) {
        if (drawingCanvas.style.pointerEvents !== 'auto') return; 
        e.preventDefault(); 
        
        isDrawing = true;
        const event = getEventCoords(e);
        const coords = getCanvasCoords(event);
        startX = coords.x;
        startY = coords.y;

        drawingCtx.strokeStyle = lineColor;
        drawingCtx.lineWidth = lineWidth;
        drawingCtx.lineCap = 'round';
        drawingCtx.lineJoin = 'round';
        
        if (currentTool === 'line') {
            drawingCtx.beginPath();
            drawingCtx.moveTo(startX, startY);
        }
        if (currentTool !== 'line') {
             saveState(); 
        }
    }

    function draw(e) {
        if (!isDrawing) return;
        e.preventDefault(); 
        
        const event = getEventCoords(e);
        const coords = getCanvasCoords(event);

        if (currentTool === 'line') {
            drawingCtx.lineTo(coords.x, coords.y);
            drawingCtx.stroke();
        } 
    }

    function stopDrawing(e) {
        if (!isDrawing) return;
        e.preventDefault(); 
        
        isDrawing = false;
        
        const event = getEventCoords(e);
        const coords = getCanvasCoords(event);
        const endX = coords.x;
        const endY = coords.y;

        const distance = Math.sqrt(Math.pow(endX - startX, 2) + Math.pow(endY - startY, 2));
        
        drawingCtx.strokeStyle = lineColor;
        drawingCtx.lineWidth = lineWidth;

        if (currentTool === 'rect' || currentTool === 'circle' || currentTool === 'arrow') {
            if (drawingHistory.length > 0) {
                 const lastState = drawingHistory[drawingHistory.length - 1];
                 const img = new Image();
                 img.onload = function() {
                     drawingCtx.clearRect(0, 0, drawingCanvas.width, drawingCanvas.height);
                     drawingCtx.drawImage(img, 0, 0);
                     drawFinalShape(startX, startY, endX, endY);
                     saveState(); 
                 };
                 img.src = lastState;
            } else {
                 drawFinalShape(startX, startY, endX, endY);
                 saveState();
            }
        } else if (currentTool === 'line') {
            if (distance < 5) {
                 drawingCtx.beginPath();
                 drawingCtx.arc(startX, startY, lineWidth / 2, 0, 2 * Math.PI);
                 drawingCtx.fillStyle = lineColor;
                 drawingCtx.fill();
            }
            saveState();
        }
    }

    function drawFinalShape(x0, y0, x1, y1) {
         const w = x1 - x0;
         const h = y1 - y0;
         const distance = Math.sqrt(Math.pow(w, 2) + Math.pow(h, 2));

         if (distance < 5 && currentTool !== 'arrow') return; 

         if (currentTool === 'rect') {
             drawingCtx.strokeRect(x0, y0, w, h);
         } else if (currentTool === 'circle') {
             const radiusX = Math.abs(w / 2);
             const radiusY = Math.abs(h / 2);
             const centerX = x0 + w / 2;
             const centerY = y0 + h / 2;

             drawingCtx.beginPath();
             drawingCtx.ellipse(centerX, centerY, radiusX, radiusY, 0, 0, 2 * Math.PI);
             drawingCtx.stroke();
         } else if (currentTool === 'arrow') {
             drawingCtx.beginPath();
             drawingCtx.moveTo(x0, y0);
             drawingCtx.lineTo(x1, y1);
             drawingCtx.stroke();
             drawArrowhead(drawingCtx, x1, y1, x0, y0, lineWidth);
         }
    }

    function clearDrawing() {
        if(drawingCanvas) {
             drawingCtx.clearRect(0, 0, drawingCanvas.width, drawingCanvas.height);
             drawingHistory = []; 
        }
    }

    // 11. æ ¸å¿ƒåŠŸèƒ½ï¼šç”Ÿæˆæµ®æ°´å°ç…§ç‰‡ (å·²ä¿®æ­£é«˜è§£æåº¦å•é¡Œ)
    function generateWatermark() {
        displayStatus("æ­£åœ¨è™•ç†ä¸­ï¼Œè«‹ç¨å€™...");
        
        const photoInput = document.getElementById('photo');
        
        // å–å¾—æ‰€æœ‰è¼¸å…¥å€¼
        const project = getInputValue('project_select', 'custom_project_name');
        const date = document.getElementById('date_time').value;
        const floor = document.getElementById('floor_select').value;
        const task = getInputValue('task_select', 'custom_task_name');
        const position = document.getElementById('position_select').value;
        const showTime = document.getElementById('show_date_time').checked;
        const remark = document.getElementById('task_remark').value.trim(); 

        // æª¢æŸ¥æ˜¯å¦æ¼å¡« (ä¸è®Š)
        if (!photoInput.files || !photoInput.files[0] || project === null || task === null || !floor || floor === "" || !position || position === "") {
            displayStatus("ğŸš« éŒ¯èª¤ï¼šè«‹ç¢ºä¿å·²é¸æ“‡ç…§ç‰‡ä¸¦å¡«å¯«æ‰€æœ‰å¿…å¡«æ¬„ä½ï¼", true);
            return;
        }
        
        const reader = new FileReader();
        
        reader.onload = function(e) {
            const img = new Image();
            img.src = e.target.result;

            img.onload = function() {
                try {
                    // --- æ ¸å¿ƒä¿®æ­£ï¼šå®‰å…¨å°ºå¯¸èª¿æ•´æ©Ÿåˆ¶ ---
                    const MAX_SIZE = 4096; // å°‡æœ€å¤§é‚Šé•·é™åˆ¶åœ¨ 4096 åƒç´ ä»¥ç¢ºä¿ç€è¦½å™¨é †åˆ©è™•ç†
                    let newWidth = img.width;
                    let newHeight = img.height;

                    if (newWidth > newHeight && newWidth > MAX_SIZE) {
                        newHeight = Math.round(newHeight * MAX_SIZE / newWidth);
                        newWidth = MAX_SIZE;
                    } else if (newHeight > MAX_SIZE) {
                        newWidth = Math.round(newWidth * MAX_SIZE / newHeight);
                        newHeight = MAX_SIZE;
                    }

                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');

                    // ä½¿ç”¨è¨ˆç®—å¾Œçš„æ–°å°ºå¯¸
                    canvas.width = newWidth;
                    canvas.height = newHeight;
                    // ç¹ªè£½ç¸®å°å¾Œçš„åœ–ç‰‡
                    ctx.drawImage(img, 0, 0, newWidth, newHeight);
                    
                    // è¨­å®šç¹ªåœ– Canvas çš„å…§éƒ¨è§£æåº¦ï¼Œèˆ‡ç¸®å°å¾Œçš„åœ–ç‰‡ä¸€è‡´
                    drawingCanvas.width = newWidth;
                    drawingCanvas.height = newHeight;
                    
                    // å°‡ç¹ªåœ–å…§å®¹ç¹ªè£½åˆ°æµ®æ°´å°åœ–å±¤ä¸Š (å¦‚æœå·²ç¶“æœ‰ç¹ªåœ–)
                    ctx.drawImage(drawingCanvas, 0, 0);


                    // --- ç¹ªè£½æµ®æ°´å°æ¨£å¼è¨­å®š (è‡ªå‹•é©æ‡‰æ–°å°ºå¯¸) ---
                    
                    const baseSize = canvas.width;
                    const fontSize = Math.floor(baseSize * 0.025); 
                    const lineHeight = fontSize * 1.4;
                    
                    const paddingFactor = 0.8; 
                    const padding = fontSize * paddingFactor; 
                    
                    ctx.font = `bold ${fontSize}px "Microsoft JhengHei", Arial`;
                    ctx.textBaseline = 'bottom';
                    
                    ctx.textAlign = 'left'; 
                    
                    let startY = canvas.height - padding;

                    // æµ®æ°´å°å…§å®¹å»ºæ§‹ (ç•¥)
                    let lines = [
                        `${project}`,         
                        `å·¥é …ï¼š ${task}`,
                        `ä½ç½®ï¼š ${position}`,
                        `æ¨“å±¤ï¼š ${floor}`      
                    ];
                    
                    if (showTime) {
                        lines.splice(1, 0, `æ™‚é–“ï¼š ${date}`); 
                    }
                    if (remark) {
                        const taskIndex = lines.findIndex(line => line.startsWith('å·¥é …ï¼š'));
                        if (taskIndex !== -1) {
                             lines.splice(taskIndex + 1, 0, `å‚™è¨»ï¼š ${remark}`);
                        } else {
                             lines.push(`å‚™è¨»ï¼š ${remark}`);
                        }
                    }

                    // 1. è¨ˆç®—èƒŒæ™¯æ¢å¯¬åº¦ (è‡ªå‹•é©æ‡‰æœ€é•·è¡Œ)
                    let maxWidth = 0;
                    lines.forEach(line => {
                        const currentWidth = ctx.measureText(line).width;
                        if (currentWidth > maxWidth) {
                            maxWidth = currentWidth;
                        }
                    });
                    
                    const backgroundWidth = maxWidth + 2 * padding; 
                    const totalHeight = lines.length * lineHeight + (lines.length > 0 ? lineHeight * 0.5 : 0);
                    
                    const backgroundY = startY - totalHeight + lineHeight * 0.5;
                    
                    // èƒŒæ™¯å¡Šåœ¨å³ä¸‹è§’
                    const backgroundX = canvas.width - backgroundWidth; 
                    
                    // æ–‡å­—ç¹ªè£½çš„èµ·å§‹ X é» (å·¦é‚Šç•Œ + å…§é‚Šè·)
                    const startX = backgroundX + padding; 

                    // ç¹ªè£½é»‘è‰²é€æ˜åº¦ 60% çš„èƒŒæ™¯æ¢
                    ctx.fillStyle = 'rgba(0, 0, 0, 0.6)'; 
                    ctx.fillRect(backgroundX, backgroundY, backgroundWidth, totalHeight + padding); 

                    // 2. ç¹ªè£½æ–‡å­— (ä½¿ç”¨å·¦å°é½Šçš„ startX)
                    lines.forEach((line, index) => {
                        const y = startY - ((lines.length - 1 - index) * lineHeight);
                        
                        // æ–‡å­—è¨­å®šï¼šé»ƒè‰²å¡«å……æ–‡å­—èˆ‡é»‘è‰²æé‚Š
                        ctx.strokeStyle = 'black';
                        ctx.lineWidth = fontSize / 8;
                        ctx.strokeText(line, startX, y); // å·¦å°é½Šåˆ° startX

                        ctx.fillStyle = '#FFD700'; 
                        ctx.fillText(line, startX, y); // å·¦å°é½Šåˆ° startX
                    });

                    // è¼¸å‡ºçµæœ
                    const dataURL = canvas.toDataURL('image/jpeg', 0.9);
                    const resultImg = document.getElementById('result_image');
                    resultImg.src = dataURL;
                    
                    document.getElementById('result_area').style.display = 'block';
                    document.getElementById('download_button').style.display = 'block';
                    
                    // é‡ç½®ç¹ªåœ–ç‹€æ…‹å’Œæ­·å²è¨˜éŒ„ï¼Œä¸¦å„²å­˜ç¬¬ä¸€æ­¥çš„ç©ºç‹€æ…‹
                    clearDrawing(); 
                    saveState(); 
                    drawingCanvas.style.pointerEvents = 'auto'; 
                    
                    displayStatus("âœ… æµ®æ°´å°ç…§ç‰‡å·²æˆåŠŸç”Ÿæˆï¼æ‚¨ç¾åœ¨å¯ä»¥é–‹å§‹ç¹ªåœ–ã€‚", false);
                    document.getElementById('result_area').scrollIntoView({ behavior: 'smooth' });

                } catch (error) {
                    console.error("Canvas Processing Error:", error);
                    // å³ä½¿åŠ å…¥äº†å°ºå¯¸èª¿æ•´ï¼Œé‚„æ˜¯æé†’å¯èƒ½æ˜¯è¨˜æ†¶é«”å•é¡Œ
                    displayStatus(`ğŸš« å…§éƒ¨éŒ¯èª¤ï¼šç…§ç‰‡è™•ç†å¤±æ•—ã€‚å·²å˜—è©¦å°ºå¯¸èª¿æ•´ï¼Œè‹¥ä»å¤±æ•—ï¼Œè«‹å˜—è©¦é¸æ“‡æª”æ¡ˆè¼ƒå°çš„ç…§ç‰‡ã€‚`, true);
                }
            };
        };
        
        reader.onerror = function(e) {
            displayStatus("ğŸš« æª”æ¡ˆè®€å–å¤±æ•—ï¼", true);
        };

        reader.readAsDataURL(photoInput.files[0]);
    }
</script>

</body>
</html>