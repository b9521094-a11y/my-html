<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å·¥ç¨‹ç…§ç‰‡æµ®æ°´å°ç”¢ç”Ÿå™¨ (ä¿®æ­£ç‰ˆ)</title>
    <style>
        body { font-family: 'Microsoft JhengHei', Arial, sans-serif; margin: 0; background-color: #f4f4f9; padding: 15px; }
        .container { max-width: 600px; margin: auto; background: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
        h2 { color: #007bff; border-bottom: 2px solid #ddd; padding-bottom: 10px; text-align: center; }
        label { display: block; margin-top: 15px; font-weight: bold; color: #333; }
        input[type="text"], input[type="date"], input[type="file"], select { 
            width: 100%; padding: 12px; margin-top: 5px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; font-size: 16px;
        }
        select { height: 45px; background: white; }
        .hidden-input { display: none; margin-top: 10px; } 
        #status_message { margin-top: 15px; text-align: center; font-weight: bold; min-height: 20px; color: red; } /* ç‹€æ…‹è¨Šæ¯å€ */
        button { background-color: #007bff; color: white; padding: 15px 20px; border: none; border-radius: 4px; cursor: pointer; margin-top: 25px; font-size: 18px; width: 100%; font-weight: bold; }
        button:hover { background-color: #0056b3; }
        
        /* çµæœé è¦½å€ */
        #result_area { margin-top: 30px; text-align: center; display: none; }
        #result_area img { max-width: 100%; border: 2px solid #333; border-radius: 4px; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        .download-hint { color: #d9534f; margin-top: 10px; font-size: 14px; }
    </style>
</head>
<body>

<div class="container">
    <h2>ğŸ“¸ å·¥ç¨‹ç…§ç‰‡æµ®æ°´å°</h2>
    
    <div>
        <label for="photo">1. æ·»åŠ ç…§ç‰‡ (ç›¸æ©Ÿæˆ–ç›¸ç°¿)</label>
        <input type="file" id="photo" accept="image/*">
        
        <hr>

        <label for="project_select">2. å·¥ç¨‹åç¨±</label>
        <select id="project_select" onchange="toggleCustomInput('project_select', 'custom_project_div', 'custom_project_name')">
            <option value="" disabled selected>è«‹é¸æ“‡å·¥ç¨‹</option>
            <option value="è¥¿æ¸¯åœ‹ä¸­113å¹´åº¦å»šæˆ¿æ“´å»ºå·¥ç¨‹">è¥¿æ¸¯åœ‹ä¸­113å¹´åº¦å»šæˆ¿æ“´å»ºå·¥ç¨‹</option>
            <option value="ç¶œåˆè¡Œæ”¿å¤§æ¨“(å«äºæ´²èˆªç©ºæ•…äº‹é¤¨ç©ºé–“)æ–°å»ºå·¥ç¨‹">ç¶œåˆè¡Œæ”¿å¤§æ¨“æ–°å»ºå·¥ç¨‹</option>
            <option value="custom_new">è‡ªè¡Œè¼¸å…¥ (å¯ç·¨è¼¯)</option>
        </select>
        <div id="custom_project_div" class="hidden-input">
            <input type="text" id="custom_project_name" placeholder="è«‹è¼¸å…¥å·¥ç¨‹åç¨±">
        </div>
        
        <label for="date_time">3. æ‹æ”æ™‚é–“</label>
        <input type="date" id="date_time">

        <label for="floor_select">3. æ¨“å±¤</label>
        <select id="floor_select">
            <option value="" disabled selected>è«‹é¸æ“‡æ¨“å±¤</option>
            <option value="B1F">B1F</option>
            <option value="1F">1F</option>
            <option value="2F">2F</option>
            <option value="3F">3F</option>
            <option value="4F">4F</option>
            <option value="5F">5F</option>
        </select>
        
        <label for="task_select">4. å·¥é …å…§å®¹ (å–®é¸)</label>
        <select id="task_select" onchange="toggleCustomInput('task_select', 'custom_task_div', 'custom_task_name')">
            <option value="" disabled selected>è«‹é¸æ“‡å·¥é …</option>
            <option value="æ¨¡æ¿">æ¨¡æ¿</option>
            <option value="é‹¼ç­‹">é‹¼ç­‹</option>
            <option value="æ°´é›»">æ°´é›»</option>
            <option value="æ¶ˆé˜²">æ¶ˆé˜²</option>
            <option value="æ”¾æ¨£">æ”¾æ¨£</option>
            <option value="custom_new">è‡ªè¡Œè¼¸å…¥ (å¯ç·¨è¼¯)</option>
        </select>
        <div id="custom_task_div" class="hidden-input">
            <input type="text" id="custom_task_name" placeholder="è«‹è¼¸å…¥å·¥é …å…§å®¹">
        </div>

        <label for="position_select">5. ä½ç½®</label>
        <select id="position_select">
            <option value="" disabled selected>è«‹é¸æ“‡ä½ç½®</option>
            <option value="æ¨‘">æ¨‘</option>
            <option value="æŸ±">æŸ±</option>
            <option value="å¤©èŠ±æ¿">å¤©èŠ±æ¿</option>
            <option value="åœ°åª">åœ°åª</option>
            <option value="ç‰†">ç‰†</option>
            <option value="æ¨“æ¢¯">æ¨“æ¢¯</option>
            <option value="æ°´æ± ">æ°´æ± </option>
        </select>
        
        <div id="status_message"></div>
        
        <button type="button" onclick="generateWatermark()">ç”Ÿæˆå¸¶æœ‰æµ®æ°´å°çš„ç…§ç‰‡</button>
    </div>

    <div id="result_area">
        <h3>âœ… ç”Ÿæˆçµæœ (é•·æŒ‰åœ–ç‰‡å¯å„²å­˜)</h3>
        <p class="download-hint">å¦‚æœåœ–ç‰‡æ²’æœ‰ç«‹å³é¡¯ç¤ºï¼Œè«‹ç¢ºèªæ‰€æœ‰æ¬„ä½éƒ½å·²å¡«å¯«ä¸¦é‡è©¦ã€‚</p>
        <img id="result_image" alt="ç”Ÿæˆçµæœ">
    </div>
</div>

<script>
    // 1. è¨­å®šä»Šæ—¥æ—¥æœŸ
    window.onload = function() {
        const now = new Date();
        const year = now.getFullYear();
        const month = String(now.getMonth() + 1).padStart(2, '0');
        const day = String(now.getDate()).padStart(2, '0');
        document.getElementById('date_time').value = `${year}-${month}-${day}`;
        document.getElementById('status_message').style.display = 'none'; // é è¨­éš±è—
    };

    // 2. é¡¯ç¤º/éš±è—ç‹€æ…‹è¨Šæ¯
    function displayStatus(message, isError = false) {
        const statusDiv = document.getElementById('status_message');
        statusDiv.textContent = message;
        statusDiv.style.color = isError ? '#d9534f' : '#5cb85c'; // ç´…è‰²æˆ–ç¶ è‰²
        statusDiv.style.display = 'block';
    }

    // 3. åˆ‡æ›è‡ªè¨‚è¼¸å…¥æ¡†é¡¯ç¤º
    function toggleCustomInput(selectId, divId, inputId) {
        const select = document.getElementById(selectId);
        const div = document.getElementById(divId);
        const input = document.getElementById(inputId);

        if (select.value === "custom_new") {
            div.style.display = "block";
            if (input) input.setAttribute('required', 'required'); // è¨­ç‚ºå¿…å¡«
        } else {
            div.style.display = "none";
            if (input) input.removeAttribute('required'); // ç§»é™¤å¿…å¡«
        }
    }

    // 4. å–å¾—æœ€çµ‚è¼¸å…¥å€¼ (è™•ç†è‡ªè¨‚è¼¸å…¥é‚è¼¯)
    function getInputValue(selectId, customInputId) {
        const select = document.getElementById(selectId);
        if (!select) return "";
        
        if (select.value === "custom_new") {
            const customInput = document.getElementById(customInputId);
            return customInput ? customInput.value.trim() : "";
        }
        return select.value;
    }

    // 5. æ ¸å¿ƒåŠŸèƒ½ï¼šç”Ÿæˆæµ®æ°´å°ç…§ç‰‡
    function generateWatermark() {
        displayStatus("æ­£åœ¨è™•ç†ä¸­ï¼Œè«‹ç¨å€™...");
        
        const photoInput = document.getElementById('photo');
        if (!photoInput.files || !photoInput.files[0]) {
            displayStatus("ğŸš« éŒ¯èª¤ï¼šè«‹å…ˆé¸æ“‡ä¸€å¼µç…§ç‰‡ï¼", true);
            return;
        }

        // å–å¾—æ‰€æœ‰è¼¸å…¥å€¼
        const project = getInputValue('project_select', 'custom_project_name');
        const date = document.getElementById('date_time').value;
        const floor = document.getElementById('floor_select').value;
        const task = getInputValue('task_select', 'custom_task_name');
        const