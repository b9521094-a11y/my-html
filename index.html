<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å·¥ç¨‹ç…§ç‰‡æµ®æ°´å°ç”¢ç”Ÿå™¨ (æœ€çµ‚ç©©å®šç‰ˆ)</title>
    <style>
        body { font-family: 'Microsoft JhengHei', Arial, sans-serif; margin: 0; background-color: #f4f4f9; padding: 15px; }
        .container { max-width: 600px; margin: auto; background: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
        h2 { color: #007bff; border-bottom: 2px solid #ddd; padding-bottom: 10px; text-align: center; }
        label { display: block; margin-top: 15px; font-weight: bold; color: #333; }
        input[type="text"], input[type="date"], input[type="file"], select { 
            width: 100%; padding: 12px; margin-top: 5px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; font-size: 16px;
        }
        select { height: 45px; background: white; }
        .hidden-input { display: none; margin-top: 10px; } 
        #status_message { margin-top: 15px; text-align: center; font-weight: bold; min-height: 20px; color: red; } /* ç‹€æ…‹è¨Šæ¯å€ */
        button { background-color: #007bff; color: white; padding: 15px 20px; border: none; border-radius: 4px; cursor: pointer; margin-top: 25px; font-size: 18px; width: 100%; font-weight: bold; }
        button:hover { background-color: #0056b3; }
        
        /* çµæœé è¦½å€ */
        #result_area { margin-top: 30px; text-align: center; display: none; }
        #result_area img { max-width: 100%; border: 2px solid #333; border-radius: 4px; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        .download-hint { color: #d9534f; margin-top: 10px; font-size: 14px; }
    </style>
</head>
<body>

<div class="container">
    <h2>ğŸ“¸ å·¥ç¨‹ç…§ç‰‡æµ®æ°´å°</h2>
    
    <div>
        <label for="photo">1. æ·»åŠ ç…§ç‰‡ (ç›¸æ©Ÿæˆ–ç›¸ç°¿)</label>
        <input type="file" id="photo" accept="image/*">
        
        <hr>

        <label for="project_select">2. å·¥ç¨‹åç¨±</label>
        <select id="project_select" onchange="toggleCustomInput('project_select', 'custom_project_div')">
            <option value="" disabled selected>è«‹é¸æ“‡å·¥ç¨‹</option>
            <option value="è¥¿æ¸¯åœ‹ä¸­113å¹´åº¦å»šæˆ¿æ“´å»ºå·¥ç¨‹">è¥¿æ¸¯åœ‹ä¸­113å¹´åº¦å»šæˆ¿æ“´å»ºå·¥ç¨‹</option>
            <option value="ç¶œåˆè¡Œæ”¿å¤§æ¨“(å«äºæ´²èˆªç©ºæ•…äº‹é¤¨ç©ºé–“)æ–°å»ºå·¥ç¨‹">ç¶œåˆè¡Œæ”¿å¤§æ¨“æ–°å»ºå·¥ç¨‹</option>
            <option value="custom_new">è‡ªè¡Œè¼¸å…¥ (å¯ç·¨è¼¯)</option>
        </select>
        <div id="custom_project_div" class="hidden-input">
            <input type="text" id="custom_project_name" placeholder="è«‹è¼¸å…¥å·¥ç¨‹åç¨±">
        </div>
        
        <label for="date_time">3. æ‹æ”æ™‚é–“</label>
        <input type="date" id="date_time">

        <label for="floor_select">3. æ¨“å±¤</label>
        <select id="floor_select">
            <option value="" disabled selected>è«‹é¸æ“‡æ¨“å±¤</option>
            <option value="B1F">B1F</option>
            <option value="1F">1F</option>
            <option value="2F">2F</option>
            <option value="3F">3F</option>
            <option value="4F">4F</option>
            <option value="5F">5F</option>
        </select>
        
        <label for="task_select">4. å·¥é …å…§å®¹</label> 
        <select id="task_select" onchange="toggleCustomInput('task_select', 'custom_task_div')">
            <option value="" disabled selected>è«‹é¸æ“‡å·¥é …</option>
            <option value="æ¨¡æ¿">æ¨¡æ¿</option>
            <option value="é‹¼ç­‹">é‹¼ç­‹</option>
            <option value="æ°´é›»">æ°´é›»</option>
            <option value="æ¶ˆé˜²">æ¶ˆé˜²</option>
            <option value="æ”¾æ¨£">æ”¾æ¨£</option>
            <option value="custom_new">è‡ªè¡Œè¼¸å…¥ (å¯ç·¨è¼¯)</option>
        </select>
        <div id="custom_task_div" class="hidden-input">
            <input type="text" id="custom_task_name" placeholder="è«‹è¼¸å…¥å·¥é …å…§å®¹">
        </div>

        <label for="position_select">5. ä½ç½®</label>
        <select id="position_select">
            <option value="" disabled selected>è«‹é¸æ“‡ä½ç½®</option>
            <option value="æ¨‘">æ¨‘</option>
            <option value="æŸ±">æŸ±</option>
            <option value="å¤©èŠ±æ¿">å¤©èŠ±æ¿</option>
            <option value="åœ°åª">åœ°åª</option>
            <option value="ç‰†">ç‰†</option>
            <option value="æ¨“æ¢¯">æ¨“æ¢¯</option>
            <option value="æ°´æ± ">æ°´æ± </option>
        </select>
        
        <div id="status_message"></div>
        
        <button type="button" onclick="generateWatermark()">ç”Ÿæˆå¸¶æœ‰æµ®æ°´å°çš„ç…§ç‰‡</button>
    </div>

    <div id="result_area">
        <h3>âœ… ç”Ÿæˆçµæœ (é•·æŒ‰åœ–ç‰‡å¯å„²å­˜)</h3>
        <p class="download-hint">å¦‚æœåœ–ç‰‡æ²’æœ‰ç«‹å³é¡¯ç¤ºï¼Œè«‹ç¢ºèªæ‰€æœ‰æ¬„ä½éƒ½å·²å¡«å¯«ï¼Œæˆ–å˜—è©¦é¸æ“‡è§£æåº¦è¼ƒä½çš„åœ–ç‰‡ã€‚</p>
        <img id="result_image" alt="ç”Ÿæˆçµæœ">
    </div>
</div>

<script>
    // 1. è¨­å®šä»Šæ—¥æ—¥æœŸ
    window.onload = function() {
        const now = new Date();
        const year = now.getFullYear();
        const month = String(now.getMonth() + 1).padStart(2, '0');
        const day = String(now.getDate()).padStart(2, '0');
        document.getElementById('date_time').value = `${year}-${month}-${day}`;
        document.getElementById('status_message').style.display = 'none';
    };

    // 2. é¡¯ç¤º/éš±è—ç‹€æ…‹è¨Šæ¯
    function displayStatus(message, isError = false) {
        const statusDiv = document.getElementById('status_message');
        statusDiv.textContent = message;
        statusDiv.style.color = isError ? '#d9534f' : '#5cb85c';
        statusDiv.style.display = 'block';
    }

    // 3. ä¿®æ­£: åˆ‡æ›è‡ªè¨‚è¼¸å…¥æ¡†é¡¯ç¤º (æ›´ç°¡æ½”ç©©å®šçš„é‚è¼¯)
    function toggleCustomInput(selectId, divId) {
        const select = document.getElementById(selectId);
        const div = document.getElementById(divId);
        const input = div.querySelector('input[type="text"]'); // å°‹æ‰¾ div å…§çš„ input å…ƒç´ 

        if (select.value === "custom_new") {
            div.style.display = "block";
            if (input) input.setAttribute('required', 'required'); 
        } else {
            div.style.display = "none";
            if (input) input.removeAttribute('required'); 
        }
    }

    // 4. å–å¾—æœ€çµ‚è¼¸å…¥å€¼ (è™•ç†è‡ªè¨‚è¼¸å…¥é‚è¼¯)
    function getInputValue(selectId, customInputId) {
        const select = document.getElementById(selectId);
        
        if (select.value === "custom_new") {
            const customInput = document.getElementById(customInputId);
            const value = customInput ? customInput.value.trim() : "";
            
            // ä¿®æ­£ 2 æª¢æŸ¥é»: å¦‚æœé¸äº†è‡ªè¨‚ä½†æ²’è¼¸å…¥ï¼Œè¿”å› null è®“ä¸»è¦é©—è­‰çŸ¥é“éŒ¯èª¤
            if (value === "") {
                return null; 
            }
            return value;
        }
        return select.value;
    }

    // 5. æ ¸å¿ƒåŠŸèƒ½ï¼šç”Ÿæˆæµ®æ°´å°ç…§ç‰‡
    function generateWatermark() {
        displayStatus("æ­£åœ¨è™•ç†ä¸­ï¼Œè«‹ç¨å€™...");
        
        const photoInput = document.getElementById('photo');
        
        // å–å¾—æ‰€æœ‰è¼¸å…¥å€¼ (ä½¿ç”¨ä¿®æ­£å¾Œçš„ getInputValue)
        const project = getInputValue('project_select', 'custom_project_name');
        const date = document.getElementById('date_time').value;
        const floor = document.getElementById('floor_select').value;
        const task = getInputValue('task_select', 'custom_task_name');
        const position = document.getElementById('position_select').value;

        // æª¢æŸ¥æ˜¯å¦æ¼å¡« (åŒ…å«è‡ªè¨‚è¼¸å…¥æ¡†å…§å®¹æª¢æŸ¥)
        if (!photoInput.files || !photoInput.files[0]) {
            displayStatus("ğŸš« éŒ¯èª¤ï¼šè«‹å…ˆé¸æ“‡ä¸€å¼µç…§ç‰‡ï¼", true);
            return;
        }

        if (project === null) {
            displayStatus("ğŸš« éŒ¯èª¤ï¼šè«‹è¼¸å…¥å·¥ç¨‹åç¨±çš„è‡ªè¨‚å…§å®¹ï¼", true);
            return;
        }

        if (task === null) {
            displayStatus("ğŸš« éŒ¯èª¤ï¼šè«‹è¼¸å…¥å·¥é …å…§å®¹çš„è‡ªè¨‚å…§å®¹ï¼", true);
            return;
        }
        
        if (!floor || floor === "" || !position || position === "") {
            displayStatus("ğŸš« éŒ¯èª¤ï¼šè«‹ç¢ºä¿æ‰€æœ‰ä¸‹æ‹‰é¸å–®éƒ½å·²é¸æ“‡ï¼", true);
            return;
        }
        
        // --- æª”æ¡ˆè®€å–èˆ‡ç¹ªè£½é–‹å§‹ ---
        
        const reader = new FileReader();
        
        reader.onload = function(e) {
            const img = new Image();
            img.src = e.target.result;
            
            img.onerror = function() {
                displayStatus("ğŸš« éŒ¯èª¤ï¼šç„¡æ³•è¼‰å…¥ç…§ç‰‡ï¼Œè«‹æª¢æŸ¥æª”æ¡ˆæ ¼å¼æˆ–å˜—è©¦è¼ƒå°çš„æª”æ¡ˆã€‚", true);
            };

            img.onload = function() {
                try {
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');

                    canvas.width = img.width;
                    canvas.height = img.height;
                    ctx.drawImage(img, 0, 0);

                    // --- ç¹ªè£½æµ®æ°´å°æ¨£å¼è¨­å®š ---
                    
                    const fontSize = Math.floor(canvas.width * 0.025); 
                    const lineHeight = fontSize * 1.4;
                    const padding = fontSize * 1.5; 
                    
                    ctx.font = `bold ${fontSize}px "Microsoft JhengHei", Arial`;
                    ctx.textBaseline = 'bottom';
                    ctx.textAlign = 'right';

                    const lines = [
                        `5. ä½ç½®: ${position}`,     
                        `4. å·¥é …: ${task}`,
                        `3. æ¨“å±¤: ${floor}`,
                        `3. æ™‚é–“: ${date}`,
                        `2. å·¥ç¨‹åç¨±: ${project}`  
                    ];

                    let startX = canvas.width - padding;
                    let startY = canvas.height - padding;

                    lines.forEach((line, index) => {
                        const y = startY - (index * lineHeight);
                        
                        // é»‘è‰²æé‚Š (è®“æ–‡å­—æ¸…æ™°)
                        ctx.strokeStyle = 'black';
                        ctx.lineWidth = fontSize / 5;
                        ctx.strokeText(line, startX, y);

                        // é»ƒè‰²å¡«å……æ–‡å­—
                        ctx.fillStyle = '#FFD700'; 
                        ctx.fillText(line, startX, y);
                    });

                    // è¼¸å‡ºçµæœ
                    const dataURL = canvas.toDataURL('image/jpeg', 0.9);
                    const resultImg = document.getElementById('result_image');
                    resultImg.src = dataURL;
                    
                    document.getElementById('result_area').style.display = 'block';
                    displayStatus("âœ… æµ®æ°´å°ç…§ç‰‡å·²æˆåŠŸç”Ÿæˆï¼", false);
                    document.getElementById('result_area').scrollIntoView({ behavior: 'smooth' });

                } catch (error) {
                    console.error("Canvas Processing Error:", error);
                    displayStatus(`ğŸš« å…§éƒ¨éŒ¯èª¤ï¼šç…§ç‰‡è™•ç†å¤±æ•—ã€‚è«‹å˜—è©¦é¸æ“‡è§£æåº¦è¼ƒä½çš„ç…§ç‰‡ã€‚`, true);
                }
            };
        };
        
        reader.onerror = function(e) {
            displayStatus("ğŸš« æª”æ¡ˆè®€å–å¤±æ•—ï¼", true);
        };

        reader.readAsDataURL(photoInput.files[0]);
    }
</script>

</body>
</html>