<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å·¥ç¨‹ç…§ç‰‡æµ®æ°´å°ç”¢ç”Ÿå™¨ (ç§»å‹•ç«¯å„ªåŒ–ç‰ˆ)</title>
    <style>
        /* --- ä¿ç•™åŸå§‹å·¥æ¥­é¢¨è¨­è¨ˆ --- */
        body { font-family: 'Microsoft JhengHei', Arial, sans-serif; margin: 0; background-color: #e0e0e0; padding: 25px; }
        .container { max-width: 650px; margin: auto; background: #ffffff; padding: 30px; border-radius: 4px; box-shadow: 0 4px 15px rgba(0,0,0,0.3); border: 2px solid #495057; }
        h2 { color: #343a40; border-bottom: 5px solid #ffc107; padding-bottom: 15px; text-align: center; margin-bottom: 25px; }
        label { display: block; margin-top: 20px; font-weight: bold; color: #343a40; font-size: 1.05em; }
        input[type="text"], input[type="date"], input[type="file"], select { width: 100%; padding: 12px; margin-top: 8px; border: 2px solid #6c757d; border-radius: 0; box-sizing: border-box; font-size: 16px; background-color: #f8f9fa; }
        
        .btn-primary { background-color: #343a40; color: white; padding: 15px 20px; border: none; border-radius: 4px; cursor: pointer; margin-top: 25px; font-size: 18px; width: 100%; font-weight: bold; }
        .btn-secondary { background-color: #007bff; color: white; padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; margin-top: 10px; font-size: 16px; width: 100%; }
        .btn-clear { background-color: #dc3545; }

        /* ç¹ªåœ–å·¥å…·å€ */
        #drawing_tools { background-color: #343a40; padding: 15px; border-radius: 4px; border: 1px solid #6c757d; }
        .tool-btn { background-color: #6c757d; color: white; padding: 8px 12px; border: none; border-radius: 4px; cursor: pointer; margin: 2px; font-size: 14px; }
        .tool-btn[data-selected="true"] { background-color: #007bff; box-shadow: 0 0 8px rgba(0, 123, 255, 0.6); }
        .undo-btn { background-color: #ffc107 !important; color: #343a40 !important; font-weight: bold; }
        
        .color-swatch-container { display: flex; gap: 8px; justify-content: center; margin-top: 15px; }
        .color-swatch { width: 35px; height: 35px; border-radius: 50%; cursor: pointer; border: 3px solid #6c757d; }
        .color-swatch[data-selected="true"] { border-color: #ffc107; transform: scale(1.15); }

        #result_area { margin-top: 30px; text-align: center; display: none; }
        #drawing_container { position: relative; max-width: 100%; display: inline-block; box-shadow: 0 5px 15px rgba(0,0,0,0.2); }
        #result_image { max-width: 100%; border: 2px solid #343a40; display: block; }
        #drawing_canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; }
        
        .download-hint { color: #dc3545; margin-top: 10px; font-size: 14px; font-weight: bold; background: #fff3cd; padding: 10px; border-radius: 4px; }
        .hidden-input { display: none; margin-top: 10px; }
        #status_message { margin-top: 20px; text-align: center; font-weight: bold; min-height: 20px; }
    </style>
</head>
<body>

<div class="container">
    <h2>ğŸ“¸ å·¥ç¨‹ç…§ç‰‡æµ®æ°´å°ç”¢ç”Ÿå™¨</h2>
    
    <div>
        <label for="photo">æ­¥é©Ÿ 1: æ‹ç…§æˆ–å¾ç›¸ç°¿é¸å–ç…§ç‰‡</label>
        <input type="file" id="photo" accept="image/*">
        
        <hr>

        <label for="project_select">æ­¥é©Ÿ 2: å¡«å¯«è³‡æ–™ - å·¥ç¨‹åç¨±</label>
        <select id="project_select" onchange="toggleCustomInput('project_select', 'custom_project_div'); saveProjectName()">
            <option value="" disabled selected>è«‹é¸æ“‡å·¥ç¨‹</option>
            <option value="è¥¿æ¸¯åœ‹ä¸­113å¹´åº¦å»šæˆ¿æ“´å»ºå·¥ç¨‹">è¥¿æ¸¯åœ‹ä¸­113å¹´åº¦å»šæˆ¿æ“´å»ºå·¥ç¨‹</option>
            <option value="ç¶œåˆè¡Œæ”¿å¤§æ¨“æ–°å»ºå·¥ç¨‹">ç¶œåˆè¡Œæ”¿å¤§æ¨“æ–°å»ºå·¥ç¨‹</option>
            <option value="custom_new">è‡ªè¡Œè¼¸å…¥ (å¯ç·¨è¼¯)</option>
        </select>
        <div id="custom_project_div" class="hidden-input">
            <input type="text" id="custom_project_name" placeholder="è«‹è¼¸å…¥å·¥ç¨‹åç¨±" oninput="saveProjectName()">
        </div>
        
        <label for="date_time">æ‹æ”æ™‚é–“</label>
        <input type="date" id="date_time">

        <label for="task_select">å·¥é …å…§å®¹</label> 
        <select id="task_select" onchange="toggleCustomInput('task_select', 'custom_task_div')">
            <option value="" disabled selected>è«‹é¸æ“‡å·¥é …</option>
            <option value="æ¨¡æ¿çµ„ç«‹">æ¨¡æ¿çµ„ç«‹</option>
            <option value="é‹¼ç­‹ç¶ç´®">é‹¼ç­‹ç¶ç´®</option>
            <option value="æ··å‡åœŸæ¾†ç½®">æ··å‡åœŸæ¾†ç½®</option>
            <option value="custom_new">è‡ªè¡Œè¼¸å…¥ (å¯ç·¨è¼¯)</option>
        </select>
        <div id="custom_task_div" class="hidden-input">
            <input type="text" id="custom_task_name" placeholder="è«‹è¼¸å…¥å·¥é …å…§å®¹">
        </div>

        <label for="position_select">ä½ç½®</label>
        <select id="position_select">
            <option value="æ¨‘">æ¨‘</option><option value="æŸ±">æŸ±</option><option value="ç‰ˆ">ç‰ˆ</option><option value="ç‰†">ç‰†</option>
        </select>
         
        <label for="floor_select">æ¨“å±¤</label>
        <select id="floor_select">
            <option value="1F">1F</option><option value="2F">2F</option><option value="B1F">B1F</option>
        </select>
        
        <div id="status_message"></div>
        <button type="button" class="btn-primary" onclick="generateWatermark()">æ­¥é©Ÿ 3: ç”Ÿæˆç…§ç‰‡</button>
        <button type="button" class="btn-secondary btn-clear" onclick="location.reload()">æ¸…é™¤æ‰€æœ‰å…§å®¹</button>
    </div>

    <div id="result_area">
        <h3>âœ… ç”Ÿæˆçµæœèˆ‡ç¹ªåœ–å€</h3>
        <div class="download-hint">æ‰‹æ©Ÿæç¤ºï¼šè‹¥ä¸‹è¼‰æŒ‰éˆ•ç„¡åæ‡‰ï¼Œè«‹ã€Œé•·æŒ‰åœ–ç‰‡ã€é¸æ“‡å„²å­˜ã€‚</div>
        <div id="drawing_container">
            <img id="result_image" alt="ç”Ÿæˆçµæœ">
            <canvas id="drawing_canvas"></canvas>
        </div>
        
        <div id="drawing_tools">
            <label style="color: #ffc107;">ç¹ªåœ–æ¨™è¨˜å·¥å…·</label>
            <div style="display: flex; gap: 5px; margin-bottom: 10px;">
                <button type="button" class="tool-btn" data-tool="line" data-selected="true" style="flex: 1;">ç·šæ¢</button>
                <button type="button" class="tool-btn" data-tool="circle" style="flex: 1;">åœ“å½¢</button>
                <button type="button" class="tool-btn" data-tool="rect" style="flex: 1;">æ–¹å½¢</button>
            </div>
            
            <div class="color-swatch-container">
                <div class="color-swatch" data-color="#dc3545" style="background-color: #dc3545;" data-selected="true"></div>
                <div class="color-swatch" data-color="#007bff" style="background-color: #007bff;"></div>
                <div class="color-swatch" data-color="#ffc107" style="background-color: #ffc107;"></div>
            </div>
            
            <div style="display: flex; gap: 10px; margin-top: 20px;">
                <button type="button" class="tool-btn undo-btn" onclick="undoDrawing()" style="flex: 1;">å¾©åŸ</button>
                <button type="button" class="tool-btn" onclick="clearDrawing()" style="background-color: #dc3545; flex: 1;">æ¸…é™¤æ¨™è¨˜</button>
            </div>
        </div>

        <button type="button" class="btn-secondary" onclick="mergeAndDownload()" style="background-color: #28a745; margin-top: 20px;">å„²å­˜æ¨™è¨˜ä¸¦ä¸‹è¼‰ç…§ç‰‡</button> 
    </div>
</div>

<script>
    // ç¹ªåœ–èˆ‡ç‹€æ…‹å…¨åŸŸè®Šæ•¸
    let drawingCanvas, drawingCtx, isDrawing = false;
    let currentTool = 'line', lineColor = '#dc3545', lineWidth = 5;
    let startX = 0, startY = 0, drawingHistory = [];

    window.onload = function() {
        document.getElementById('date_time').valueAsDate = new Date();
        setupDrawing();
    };

    function displayStatus(msg, isErr) {
        const s = document.getElementById('status_message');
        s.textContent = msg; s.style.color = isErr ? 'red' : 'green';
    }

    function toggleCustomInput(sid, did) {
        document.getElementById(did).style.display = document.getElementById(sid).value === "custom_new" ? "block" : "none";
    }

    // æ ¸å¿ƒåŠŸèƒ½ï¼šç”Ÿæˆæµ®æ°´å°
    function generateWatermark() {
        const file = document.getElementById('photo').files[0];
        if (!file) { displayStatus("ğŸš« è«‹é¸æ“‡ç…§ç‰‡", true); return; }
        
        displayStatus("è™•ç†ä¸­...", false);
        const reader = new FileReader();
        reader.onload = function(e) {
            const img = new Image();
            img.src = e.target.result;
            img.onload = function() {
                const maxDim = 4096;
                let w = img.width, h = img.height;
                if (w > maxDim || h > maxDim) {
                    const ratio = Math.min(maxDim/w, maxDim/h);
                    w *= ratio; h *= ratio;
                }

                const canvas = document.createElement('canvas');
                canvas.width = w; canvas.height = h;
                const ctx = canvas.getContext('2d');
                ctx.drawImage(img, 0, 0, w, h);

                // ç¹ªè£½æµ®æ°´å° (å³ä¸‹è§’åŠé€æ˜é»‘åº•)
                const fontSize = Math.floor(w * 0.025);
                ctx.fillStyle = 'rgba(0, 0, 0, 0.6)';
                ctx.fillRect(w * 0.6, h - (fontSize * 6), w * 0.4, fontSize * 6);
                
                ctx.font = `bold ${fontSize}px sans-serif`;
                ctx.fillStyle = '#FFD700';
                const proj = document.getElementById('project_select').value === "custom_new" ? document.getElementById('custom_project_name').value : document.getElementById('project_select').value;
                const textX = w * 0.62;
                ctx.fillText(`å·¥ç¨‹ï¼š${proj}`, textX, h - (fontSize * 4));
                ctx.fillText(`æ™‚é–“ï¼š${document.getElementById('date_time').value}`, textX, h - (fontSize * 2.5));
                ctx.fillText(`ä½ç½®ï¼š${document.getElementById('floor_select').value} / ${document.getElementById('position_select').value}`, textX, h - (fontSize * 1));

                document.getElementById('result_image').src = canvas.toDataURL('image/jpeg', 0.9);
                drawingCanvas.width = w; drawingCanvas.height = h;
                document.getElementById('result_area').style.display = 'block';
                drawingCanvas.style.pointerEvents = 'auto';
                displayStatus("âœ… å·²ç”Ÿæˆï¼æ‚¨å¯ä»¥åœ¨åœ–ä¸Šç¹ªåœ–æ¨™è¨˜ã€‚", false);
                saveState();
            };
        };
        reader.readAsDataURL(file);
    }

    // ä¿®æ­£é»ï¼šé‡å°æ‰‹æ©Ÿå„ªåŒ–çš„ä¸‹è¼‰åŠŸèƒ½
    function mergeAndDownload() {
        const resultImg = document.getElementById('result_image');
        const tempCanvas = document.createElement('canvas');
        tempCanvas.width = drawingCanvas.width; tempCanvas.height = drawingCanvas.height;
        const tCtx = tempCanvas.getContext('2d');
        
        const img = new Image();
        img.src = resultImg.src;
        img.onload = function() {
            tCtx.drawImage(img, 0, 0);
            tCtx.drawImage(drawingCanvas, 0, 0);
            
            const finalData = tempCanvas.toDataURL('image/jpeg', 0.9);
            // é—œéµï¼šå°‡åˆä½µå¾Œçš„åœ–å›å¡«åˆ° <img>ï¼Œè®“ä½¿ç”¨è€…é•·æŒ‰å„²å­˜
            resultImg.src = finalData;
            
            const link = document.createElement('a');
            link.href = finalData;
            link.download = `å·¥ç¨‹æ¨™è¨˜_${new Date().getTime()}.jpg`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            alert("å˜—è©¦ä¸‹è¼‰ä¸­...\nè‹¥ç„¡åæ‡‰ï¼Œè«‹ã€Œé•·æŒ‰åœ–ç‰‡ã€æ‰‹å‹•å„²å­˜ç…§ç‰‡ã€‚");
        };
    }

    // --- ç¹ªåœ–é‚è¼¯ (æ”¯æ´è§¸æ§) ---
    function setupDrawing() {
        drawingCanvas = document.getElementById('drawing_canvas');
        drawingCtx = drawingCanvas.getContext('2d');

        document.querySelectorAll('.tool-btn[data-tool]').forEach(btn => {
            btn.onclick = () => {
                currentTool = btn.dataset.tool;
                document.querySelectorAll('.tool-btn').forEach(b => b.dataset.selected = "false");
                btn.dataset.selected = "true";
            };
        });

        document.querySelectorAll('.color-swatch').forEach(swatch => {
            swatch.onclick = () => {
                lineColor = swatch.dataset.color;
                document.querySelectorAll('.color-swatch').forEach(s => s.dataset.selected = "false");
                swatch.dataset.selected = "true";
            };
        });

        const start = (e) => {
            if (drawingCanvas.style.pointerEvents === 'none') return;
            isDrawing = true;
            const pos = getPos(e);
            startX = pos.x; startY = pos.y;
            drawingCtx.strokeStyle = lineColor;
            drawingCtx.lineWidth = drawingCanvas.width * 0.005;
            drawingCtx.lineCap = 'round';
            if (currentTool === 'line') drawingCtx.beginPath();
        };

        const move = (e) => {
            if (!isDrawing || currentTool !== 'line') return;
            const pos = getPos(e);
            drawingCtx.lineTo(pos.x, pos.y);
            drawingCtx.stroke();
        };

        const end = (e) => {
            if (!isDrawing) return;
            if (currentTool !== 'line') {
                const pos = getPos(e);
                if (currentTool === 'rect') drawingCtx.strokeRect(startX, startY, pos.x - startX, pos.y - startY);
                if (currentTool === 'circle') {
                    const r = Math.sqrt((pos.x-startX)**2 + (pos.y-startY)**2);
                    drawingCtx.beginPath(); drawingCtx.arc(startX, startY, r, 0, Math.PI*2); drawingCtx.stroke();
                }
            }
            isDrawing = false;
            saveState();
        };

        drawingCanvas.addEventListener('mousedown', start);
        drawingCanvas.addEventListener('mousemove', move);
        window.addEventListener('mouseup', end);
        drawingCanvas.addEventListener('touchstart', (e) => { e.preventDefault(); start(e); });
        drawingCanvas.addEventListener('touchmove', (e) => { e.preventDefault(); move(e); });
        drawingCanvas.addEventListener('touchend', (e) => { e.preventDefault(); end(e); });
    }

    function getPos(e) {
        const rect = drawingCanvas.getBoundingClientRect();
        const ev = e.touches ? e.touches[0] : e;
        return {
            x: (ev.clientX - rect.left) * (drawingCanvas.width / rect.width),
            y: (ev.clientY - rect.top) * (drawingCanvas.height / rect.height)
        };
    }

    function saveState() {
        if (drawingHistory.length > 20) drawingHistory.shift();
        drawingHistory.push(drawingCanvas.toDataURL());
    }

    function undoDrawing() {
        if (drawingHistory.length <= 1) { clearDrawing(); return; }
        drawingHistory.pop();
        const img = new Image();
        img.src = drawingHistory[drawingHistory.length - 1];
        img.onload = () => {
            drawingCtx.clearRect(0, 0, drawingCanvas.width, drawingCanvas.height);
            drawingCtx.drawImage(img, 0, 0);
        };
    }

    function clearDrawing() {
        drawingCtx.clearRect(0, 0, drawingCanvas.width, drawingCanvas.height);
        drawingHistory = []; saveState();
    }
    
    function saveProjectName() {} // é ç•™æ“´å……
</script>

</body>
</html>